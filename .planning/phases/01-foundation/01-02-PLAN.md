---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "supa_audit extension is enabled in database"
    - "Audit tracking enabled on transactions table"
    - "Audit tracking enabled on invoices table"
    - "Audit tracking enabled on invoice_rows table"
    - "All tables have RLS enabled"
  artifacts:
    - path: "audit.record_version (Supabase table)"
      provides: "Audit trail storage"
  key_links:
    - from: "transactions table"
      to: "audit.record_version"
      via: "trigger"
      pattern: "audit_trigger"
    - from: "invoices table"
      to: "audit.record_version"
      via: "trigger"
      pattern: "audit_trigger"
---

<objective>
Verify and configure supa_audit extension for financial data audit logging on existing Supabase tables.

Purpose: Ensure all financial tables have audit trail for compliance and data integrity.
Output: Audit logging enabled on transactions, invoices, and invoice_rows tables.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and configure supa_audit extension</name>
  <files>None (database operations via MCP)</files>
  <action>
Use Supabase MCP tools to execute the following SQL operations:

1. Enable supa_audit extension (if not already enabled):
```sql
CREATE EXTENSION IF NOT EXISTS supa_audit CASCADE;
```

2. Enable audit tracking on financial tables:
```sql
SELECT audit.enable_tracking('public.transactions'::regclass);
SELECT audit.enable_tracking('public.invoices'::regclass);
SELECT audit.enable_tracking('public.invoice_rows'::regclass);
```

3. Verify RLS is enabled on all tables:
```sql
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
AND tablename IN ('user_settings', 'files', 'transactions', 'invoices', 'invoice_rows', 'credit_cards');
```

All tables should show rowsecurity = true.

4. Verify audit triggers exist:
```sql
SELECT trigger_name, event_object_table
FROM information_schema.triggers
WHERE trigger_schema = 'public'
AND trigger_name LIKE '%audit%';
```

Note: Use the mcp__supabase__execute_sql or mcp__supabase__apply_migration tools to run these queries.
  </action>
  <verify>
Query audit.record_version table to verify it exists:
```sql
SELECT COUNT(*) FROM audit.record_version;
```
Should return 0 (empty but exists).

Query to verify triggers:
```sql
SELECT tgname FROM pg_trigger WHERE tgname LIKE '%audit%';
```
Should show audit triggers for transactions, invoices, invoice_rows.
  </verify>
  <done>
supa_audit extension enabled, audit tracking active on all financial tables (transactions, invoices, invoice_rows).
  </done>
</task>

<task type="auto">
  <name>Task 2: Test audit logging with sample operation</name>
  <files>None (database operations via MCP)</files>
  <action>
Execute a test INSERT and UPDATE on the transactions table to verify audit logging works:

1. Insert a test transaction:
```sql
INSERT INTO transactions (user_id, date, description, amount_agorot, is_credit)
SELECT id, '2026-01-01', 'AUDIT TEST - DELETE ME', 1000, false
FROM auth.users
LIMIT 1;
```

2. Update the test transaction:
```sql
UPDATE transactions
SET description = 'AUDIT TEST UPDATED - DELETE ME'
WHERE description = 'AUDIT TEST - DELETE ME';
```

3. Verify audit record was created:
```sql
SELECT id, record_id, old_record_id, op, ts, table_oid
FROM audit.record_version
ORDER BY ts DESC
LIMIT 5;
```

Should show INSERT and UPDATE operations.

4. Clean up test data:
```sql
DELETE FROM transactions WHERE description LIKE 'AUDIT TEST%';
```

5. Verify DELETE was also logged:
```sql
SELECT op, COUNT(*)
FROM audit.record_version
GROUP BY op;
```

Should show counts for I (insert), U (update), D (delete).
  </action>
  <verify>
Final verification query:
```sql
SELECT
  CASE op WHEN 'I' THEN 'INSERT' WHEN 'U' THEN 'UPDATE' WHEN 'D' THEN 'DELETE' END as operation,
  COUNT(*) as count
FROM audit.record_version
GROUP BY op;
```
Should show at least one each of INSERT, UPDATE, DELETE operations from the test.
  </verify>
  <done>
Audit logging verified working - INSERT, UPDATE, DELETE operations all tracked in audit.record_version table.
  </done>
</task>

</tasks>

<verification>
1. supa_audit extension enabled and active
2. Audit triggers exist on transactions, invoices, invoice_rows tables
3. RLS enabled on all 6 tables (user_settings, files, transactions, invoices, invoice_rows, credit_cards)
4. Test operations appear in audit.record_version table
</verification>

<success_criteria>
- supa_audit extension is enabled
- Audit tracking enabled on all financial tables
- Test INSERT/UPDATE/DELETE operations logged to audit.record_version
- All tables have RLS enabled
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
