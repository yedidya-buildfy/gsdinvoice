---
phase: 04-document-upload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/storage.ts
  - src/components/upload/FileUploader.tsx
  - src/components/upload/UploadProgress.tsx
  - src/hooks/useFileUpload.ts
  - src/pages/InvoicesPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can select multiple files at once"
    - "System accepts PDF, JPG, PNG, XLSX, and CSV files"
    - "Upload progress visible during file transfer"
    - "Files stored in Supabase Storage with proper access controls"
  artifacts:
    - path: "src/lib/storage.ts"
      provides: "Supabase Storage helper functions"
      exports: ["uploadFile", "getFileUrl", "deleteFile"]
    - path: "src/components/upload/FileUploader.tsx"
      provides: "Drag-and-drop file uploader with batch support"
      min_lines: 80
    - path: "src/hooks/useFileUpload.ts"
      provides: "Upload state management hook"
      exports: ["useFileUpload"]
  key_links:
    - from: "src/components/upload/FileUploader.tsx"
      to: "src/hooks/useFileUpload.ts"
      via: "hook usage"
      pattern: "useFileUpload"
    - from: "src/hooks/useFileUpload.ts"
      to: "src/lib/storage.ts"
      via: "storage upload"
      pattern: "uploadFile"
    - from: "src/lib/storage.ts"
      to: "supabase.storage"
      via: "Supabase client"
      pattern: "supabase\\.storage"
---

<objective>
Create file upload infrastructure with Supabase Storage integration and batch upload UI.

Purpose: Enable users to upload invoices and receipts (PDF, images, xlsx, csv) with visual progress feedback. This is the foundation for document management - files must be stored securely before AI extraction can process them.

Output: Working file uploader with drag-and-drop, multi-file selection, progress indicators, and files persisted to Supabase Storage and files table.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/supabase.ts
@src/types/database.ts
@src/pages/InvoicesPage.tsx
@src/styles/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Storage helpers and upload hook</name>
  <files>
    src/lib/storage.ts
    src/hooks/useFileUpload.ts
  </files>
  <action>
Create storage utility functions in src/lib/storage.ts:
- BUCKET_NAME constant: 'documents'
- uploadFile(file: File, userId: string): Promise<{path: string, error: Error | null}>
  - Generate unique path: `${userId}/${Date.now()}-${file.name}`
  - Use supabase.storage.from(BUCKET_NAME).upload(path, file, { upsert: false })
  - Return storage path on success
- getFileUrl(path: string): string
  - Use supabase.storage.from(BUCKET_NAME).getPublicUrl(path)
  - Return public URL
- deleteFile(path: string): Promise<{error: Error | null}>
  - Use supabase.storage.from(BUCKET_NAME).remove([path])
- getFileType(file: File): 'pdf' | 'image' | 'xlsx' | 'csv' | 'unknown'
  - Check file.type and file.name extension
  - Map: application/pdf -> pdf, image/* -> image, etc.

Create upload hook in src/hooks/useFileUpload.ts:
- Interface UploadingFile: { file: File, progress: number, status: 'pending' | 'uploading' | 'success' | 'error', error?: string }
- useFileUpload() returns:
  - files: UploadingFile[] - current upload queue
  - addFiles: (files: File[]) => void - add files to queue (validate types)
  - removeFile: (index: number) => void - remove from queue
  - uploadAll: () => Promise<void> - upload all pending files
  - clearCompleted: () => void - remove successful uploads from queue
  - isUploading: boolean - any file currently uploading
- On uploadAll:
  1. For each file, set status to 'uploading'
  2. Call uploadFile from storage.ts
  3. On success: insert row into files table (use supabase client)
     - user_id from useAuth
     - storage_path from upload result
     - file_type from getFileType
     - source_type: 'invoice' (for now, can be extended)
     - original_name: file.name
     - file_size: file.size
     - status: 'pending' (awaiting AI extraction)
  4. Update progress (Supabase storage doesn't provide progress, so set to 100 on complete)
  5. Set status to 'success' or 'error'

IMPORTANT: Validate file types before adding to queue. Allowed: pdf, jpg, jpeg, png, xlsx, csv. Reject others with error message.
  </action>
  <verify>
Run TypeScript check: `npm run build` should pass without errors.
Check imports resolve: storage.ts imports supabase, useFileUpload imports storage and AuthContext.
  </verify>
  <done>
Storage helpers export uploadFile, getFileUrl, deleteFile, getFileType. Upload hook manages file queue with status tracking and persists to both Storage and files table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileUploader component with drag-and-drop</name>
  <files>
    src/components/upload/FileUploader.tsx
    src/components/upload/UploadProgress.tsx
    src/pages/InvoicesPage.tsx
  </files>
  <action>
Create UploadProgress component in src/components/upload/UploadProgress.tsx:
- Props: files: UploadingFile[], onRemove: (index: number) => void, onClear: () => void
- Display list of files with:
  - File name (truncated if long)
  - File size (formatted: KB/MB)
  - Status icon: pending (clock), uploading (spinner), success (check), error (x)
  - Remove button (only for pending/error)
- "Clear completed" button at bottom when any success files exist
- Use HeroIcons (outline): ClockIcon, ArrowPathIcon (spinning), CheckCircleIcon, XCircleIcon, XMarkIcon
- Style with Tailwind: bg-surface, rounded-lg, proper spacing

Create FileUploader component in src/components/upload/FileUploader.tsx:
- Props: onUploadComplete?: () => void (callback after all uploads finish)
- Use useFileUpload hook for state
- Drag-and-drop zone:
  - Border: dashed border-2 border-text-muted/40
  - Hover state: border-primary bg-primary/5
  - Active drag state: border-primary bg-primary/10
  - Icon: CloudArrowUpIcon (outline) from HeroIcons
  - Text: "Drag files here or click to browse"
  - Subtext: "PDF, JPG, PNG, XLSX, CSV"
- Hidden file input with multiple attribute
- Accept attribute: ".pdf,.jpg,.jpeg,.png,.xlsx,.csv"
- On file drop or select: call addFiles
- Show UploadProgress below drop zone when files.length > 0
- Upload button: "Upload {n} files" - calls uploadAll
  - Disabled when isUploading or no pending files
  - Show spinner when uploading
- After successful upload, call onUploadComplete if provided

Update InvoicesPage.tsx:
- Import and render FileUploader at top of page
- Keep existing placeholder content below
- Add heading: "Upload Documents"
  </action>
  <verify>
Start dev server: `npm run dev`
Navigate to /invoices page
Verify:
1. Drop zone is visible with correct styling
2. Can click to open file picker
3. Can drag files onto drop zone
4. File list appears after selection
5. Invalid file types show error
6. Upload button triggers upload
7. Progress shows during upload
8. Success/error status updates correctly
  </verify>
  <done>
FileUploader renders drag-and-drop zone, handles file selection, shows upload progress, and persists files to Supabase. InvoicesPage displays the uploader.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` passes without TypeScript errors
2. Navigate to /invoices, see file uploader
3. Select multiple files (PDF + image) via click or drag
4. Click upload, see progress updates
5. After upload, verify files appear in Supabase Storage bucket
6. Verify rows inserted in files table with correct metadata
</verification>

<success_criteria>
- User can select multiple files at once (UPLD-01 partial)
- System accepts PDF, JPG, PNG, XLSX, CSV files (UPLD-02)
- Upload progress visible during file transfer
- Files stored in Supabase Storage with user-specific paths
- File metadata saved to files table for later querying
</success_criteria>

<output>
After completion, create `.planning/phases/04-document-upload/04-01-SUMMARY.md`
</output>
