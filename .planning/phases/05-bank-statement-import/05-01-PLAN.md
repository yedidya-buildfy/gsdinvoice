---
phase: 05-bank-statement-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/parsers/index.ts
  - src/lib/parsers/xlsxParser.ts
  - src/lib/parsers/csvParser.ts
  - src/lib/parsers/bankStatementParser.ts
  - src/lib/utils/currency.ts
  - src/lib/utils/dateUtils.ts
autonomous: true

must_haves:
  truths:
    - "xlsx files can be parsed with Hebrew text preserved"
    - "csv files can be parsed with auto-delimiter detection"
    - "Israeli DD/MM/YYYY dates convert to ISO format"
    - "Shekel amounts convert to integer agorot"
  artifacts:
    - path: "src/lib/parsers/xlsxParser.ts"
      provides: "xlsx file parsing with UTF-8 Hebrew support"
      exports: ["parseXlsxFile", "xlsxToObjects"]
    - path: "src/lib/parsers/csvParser.ts"
      provides: "CSV file parsing with Hebrew support"
      exports: ["parseCsvFile"]
    - path: "src/lib/parsers/bankStatementParser.ts"
      provides: "Unified bank statement parsing with column detection"
      exports: ["parseBankStatement", "ParsedTransaction"]
    - path: "src/lib/utils/currency.ts"
      provides: "Currency conversion utilities"
      exports: ["shekelToAgorot", "agorotToShekel", "formatShekel"]
    - path: "src/lib/utils/dateUtils.ts"
      provides: "Israeli date parsing utilities"
      exports: ["parseIsraeliDate"]
  key_links:
    - from: "src/lib/parsers/bankStatementParser.ts"
      to: "src/lib/parsers/xlsxParser.ts"
      via: "import parseXlsxFile"
      pattern: "import.*xlsxParser"
    - from: "src/lib/parsers/bankStatementParser.ts"
      to: "src/lib/utils/currency.ts"
      via: "import shekelToAgorot"
      pattern: "shekelToAgorot"
    - from: "src/lib/parsers/bankStatementParser.ts"
      to: "src/lib/utils/dateUtils.ts"
      via: "import parseIsraeliDate"
      pattern: "parseIsraeliDate"
---

<objective>
Create parsing foundation for bank statement import including xlsx/csv parsers and currency/date utilities.

Purpose: Enable parsing of Israeli bank statement files with proper Hebrew text handling, flexible column detection for varied bank formats, and accurate currency/date conversion.

Output: Parsing utilities in src/lib/parsers/ and src/lib/utils/ that can process any Israeli bank xlsx/csv export.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-bank-statement-import/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install parsing dependencies</name>
  <files>package.json</files>
  <action>
Install the required npm packages for file parsing:

```bash
npm install xlsx papaparse dayjs @types/papaparse
```

Note: xlsx (SheetJS) includes TypeScript types, no separate @types/xlsx needed.
dayjs is already likely installed but include it to be safe.

Verify installation by checking package.json includes:
- xlsx: ^0.20.x
- papaparse: ^5.x
- dayjs: ^1.x
- @types/papaparse: ^5.x
  </action>
  <verify>Run `npm ls xlsx papaparse dayjs` and confirm all three packages are listed without errors.</verify>
  <done>package.json contains xlsx, papaparse, dayjs, @types/papaparse dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create utility functions for currency and date parsing</name>
  <files>src/lib/utils/currency.ts, src/lib/utils/dateUtils.ts</files>
  <action>
Create src/lib/utils/ directory if needed.

**src/lib/utils/currency.ts:**
- `shekelToAgorot(amount: number | string): number` - Convert shekel amount to integer agorot, handle string input with commas/spaces, use Math.round(amount * 100)
- `agorotToShekel(agorot: number): number` - Divide by 100
- `formatShekel(agorot: number): string` - Use Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS' })

**src/lib/utils/dateUtils.ts:**
- Import dayjs and customParseFormat plugin
- Extend dayjs with customParseFormat
- Define DATE_FORMATS array: ['DD/MM/YYYY', 'DD/MM/YY', 'DD.MM.YYYY', 'DD-MM-YYYY', 'YYYY-MM-DD']
- `parseIsraeliDate(dateStr: string | Date | number): string | null` - Handle Excel serial dates (number > 40000), Date objects, and string formats. Return ISO YYYY-MM-DD or null.

For Excel serial date conversion:
```typescript
if (typeof dateStr === 'number' && dateStr > 40000) {
  // Excel serial date: days since 1899-12-30
  const excelEpoch = new Date(1899, 11, 30);
  const jsDate = new Date(excelEpoch.getTime() + dateStr * 86400000);
  return dayjs(jsDate).format('YYYY-MM-DD');
}
```
  </action>
  <verify>Create a simple test in the terminal: import the modules and test `shekelToAgorot('1,234.56')` returns 123456, `parseIsraeliDate('25/01/2026')` returns '2026-01-25'.</verify>
  <done>Currency and date utilities export all functions, handle edge cases (commas, Excel serial dates, multiple date formats)</done>
</task>

<task type="auto">
  <name>Task 3: Create xlsx, csv, and unified bank statement parsers</name>
  <files>src/lib/parsers/xlsxParser.ts, src/lib/parsers/csvParser.ts, src/lib/parsers/bankStatementParser.ts, src/lib/parsers/index.ts</files>
  <action>
Create src/lib/parsers/ directory.

**src/lib/parsers/xlsxParser.ts:**
```typescript
import * as XLSX from 'xlsx';

export async function parseXlsxFile(file: File): Promise<unknown[][]> {
  const buffer = await file.arrayBuffer();
  const workbook = XLSX.read(buffer, {
    type: 'array',
    codepage: 65001,    // UTF-8 for Hebrew
    cellDates: true,    // Parse dates as Date objects
    cellNF: false,
    cellStyles: false
  });
  const sheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[sheetName];
  return XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
}

export function xlsxToObjects<T>(data: unknown[][], headerRow = 0): T[] {
  // Convert array of arrays to array of objects using headerRow as keys
}
```

**src/lib/parsers/csvParser.ts:**
```typescript
import Papa from 'papaparse';

export function parseCsvFile<T>(file: File): Promise<T[]> {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,
      encoding: 'UTF-8',
      skipEmptyLines: true,
      dynamicTyping: false,
      transformHeader: (header) => header.trim(),
      complete: (results) => resolve(results.data as T[]),
      error: (error) => reject(new Error(`CSV parse error: ${error.message}`))
    });
  });
}
```

**src/lib/parsers/bankStatementParser.ts:**
Define ParsedTransaction interface matching research:
```typescript
export interface ParsedTransaction {
  date: string;           // ISO YYYY-MM-DD
  valueDate: string | null;
  description: string;
  reference: string | null;
  amountAgorot: number;   // positive = income, negative = expense
  balanceAgorot: number | null;
}
```

Define COLUMN_PATTERNS for Israeli banks:
```typescript
const COLUMN_PATTERNS = {
  date: ['תאריך', 'תאריך העסקה', 'date', 'תאריך ערך'],
  valueDate: ['תאריך ערך', 'value date', 'ערך'],
  description: ['תיאור', 'פרטים', 'description', 'תאור הפעולה', 'פירוט'],
  reference: ['אסמכתא', 'reference', 'מספר אסמכתא', 'אסמכתה'],
  amount: ['סכום', 'amount', 'סכום בש"ח', 'זכות', 'חובה'],
  debit: ['חובה', 'debit', 'הוצאה'],
  credit: ['זכות', 'credit', 'הכנסה'],
  balance: ['יתרה', 'balance', 'יתרה בש"ח']
};
```

Implement:
- `detectColumnMapping(headers: string[]): Record<string, string>` - Match headers to fields
- `detectHeaderRow(data: unknown[][]): number` - Scan first 10 rows for row containing date/amount patterns
- `normalizeTransaction(row: Record<string, unknown>, mapping: Record<string, string>): ParsedTransaction` - Extract and normalize fields using currency/date utils
- `parseBankStatement(file: File): Promise<ParsedTransaction[]>` - Main entry point, detects file type (xlsx/csv), parses, detects columns, normalizes

Handle amount sign: if separate debit/credit columns, calculate as credit - debit. If single amount column, use as-is.

**src/lib/parsers/index.ts:**
Export all public functions and types from the parsers.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`. Manual test: import parseBankStatement and log typeof to confirm it's a function.</verify>
  <done>All parsers export correctly, bankStatementParser handles both xlsx and csv, column detection works for Hebrew headers, amounts converted to agorot, dates to ISO format</done>
</task>

</tasks>

<verification>
1. `npm ls xlsx papaparse dayjs` shows all packages installed
2. `npx tsc --noEmit` passes without errors
3. All files exist in src/lib/parsers/ and src/lib/utils/
4. Exports are correct: parseBankStatement, parseXlsxFile, parseCsvFile, shekelToAgorot, parseIsraeliDate
</verification>

<success_criteria>
- [ ] xlsx, papaparse, dayjs installed in package.json
- [ ] currency.ts exports shekelToAgorot, agorotToShekel, formatShekel
- [ ] dateUtils.ts exports parseIsraeliDate handling DD/MM/YYYY and Excel serial dates
- [ ] xlsxParser.ts exports parseXlsxFile with codepage 65001 for Hebrew
- [ ] csvParser.ts exports parseCsvFile with UTF-8 encoding
- [ ] bankStatementParser.ts exports parseBankStatement, ParsedTransaction, handles column detection
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-bank-statement-import/05-01-SUMMARY.md`
</output>
