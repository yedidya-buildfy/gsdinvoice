---
phase: 05-bank-statement-import
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/bank/TransactionTable.tsx
  - src/components/bank/TransactionFilters.tsx
  - src/pages/BankMovementsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can view transactions in a table"
    - "Table is sortable by date, amount, description"
    - "Table is filterable by search text, date range, type"
    - "Hebrew descriptions display correctly with RTL"
    - "Income shows positive (green), expense shows negative (red)"
  artifacts:
    - path: "src/components/bank/TransactionTable.tsx"
      provides: "Sortable transaction table with income/expense styling"
      exports: ["TransactionTable"]
    - path: "src/components/bank/TransactionFilters.tsx"
      provides: "Filter controls for transactions"
      exports: ["TransactionFilters", "TransactionFilterState"]
    - path: "src/pages/BankMovementsPage.tsx"
      provides: "Complete bank movements page with upload and table"
      exports: ["BankMovementsPage"]
  key_links:
    - from: "src/pages/BankMovementsPage.tsx"
      to: "src/hooks/useTransactions.ts"
      via: "import useTransactions"
      pattern: "useTransactions"
    - from: "src/pages/BankMovementsPage.tsx"
      to: "src/components/bank/BankUploader.tsx"
      via: "import BankUploader"
      pattern: "BankUploader"
    - from: "src/pages/BankMovementsPage.tsx"
      to: "src/components/bank/TransactionTable.tsx"
      via: "import TransactionTable"
      pattern: "TransactionTable"
---

<objective>
Create transaction display components and integrate everything into BankMovementsPage.

Purpose: Enable users to view their imported bank transactions in a sortable, filterable table with proper RTL Hebrew support and income/expense visual distinction.

Output: Complete BankMovementsPage with file upload, transaction table, and filters.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-bank-statement-import/05-RESEARCH.md
@.planning/phases/05-bank-statement-import/05-02-SUMMARY.md
@src/components/documents/DocumentTable.tsx
@src/lib/utils/currency.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TransactionFilters component</name>
  <files>src/components/bank/TransactionFilters.tsx</files>
  <action>
Create filter controls for transactions.

**Types:**
```typescript
export interface TransactionFilterState {
  search: string;
  dateFrom: string;
  dateTo: string;
  type: 'all' | 'income' | 'expense';
}

interface TransactionFiltersProps {
  filters: TransactionFilterState;
  onChange: (filters: TransactionFilterState) => void;
}
```

**Implementation:**
Create a horizontal filter bar with:
1. Search input (text field with MagnifyingGlassIcon)
2. Date from input (type="date")
3. Date to input (type="date")
4. Type select: All / Income / Expense

**Styling:**
- Use flex row with gap-4, wrap on small screens
- Input styling consistent with existing forms: bg-surface border border-text-muted/20 rounded-lg px-3 py-2
- Use logical CSS properties for RTL: ps-10 for icon padding (not pl-10)

```tsx
<div className="flex flex-wrap gap-4 items-center">
  {/* Search */}
  <div className="relative flex-1 min-w-[200px]">
    <MagnifyingGlassIcon className="absolute start-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-muted" />
    <input
      type="text"
      placeholder="Search descriptions..."
      value={filters.search}
      onChange={(e) => onChange({ ...filters, search: e.target.value })}
      className="w-full ps-10 pe-4 py-2 bg-surface border border-text-muted/20 rounded-lg text-text"
    />
  </div>

  {/* Date range */}
  <div className="flex items-center gap-2">
    <input type="date" value={filters.dateFrom} onChange={...} className="..." />
    <span className="text-text-muted">to</span>
    <input type="date" value={filters.dateTo} onChange={...} className="..." />
  </div>

  {/* Type select */}
  <select value={filters.type} onChange={...} className="bg-surface border ...">
    <option value="all">All</option>
    <option value="income">Income</option>
    <option value="expense">Expense</option>
  </select>
</div>
```

Import MagnifyingGlassIcon from @heroicons/react/24/outline.
  </action>
  <verify>Component renders with all filter controls. Changing inputs calls onChange with updated filter state.</verify>
  <done>TransactionFilters exports component and TransactionFilterState type, all filter controls work</done>
</task>

<task type="auto">
  <name>Task 2: Create TransactionTable component</name>
  <files>src/components/bank/TransactionTable.tsx</files>
  <action>
Create a sortable transaction table following DocumentTable pattern.

**Props:**
```typescript
interface TransactionTableProps {
  transactions: Transaction[];
  isLoading?: boolean;
  sortColumn: keyof Transaction;
  sortDirection: 'asc' | 'desc';
  onSort: (column: keyof Transaction) => void;
}
```

**Columns:**
1. Date - sortable, format with Intl.DateTimeFormat('he-IL')
2. Description - text, RTL via dir="auto" or natural flow
3. Reference - optional, smaller text
4. Amount - sortable, format with formatShekel from currency.ts
5. Balance - optional, format with formatShekel

**Amount styling:**
- Positive (income): text-green-400
- Negative (expense): text-red-400

**Sort indicators:**
- Clickable column headers
- Show ChevronUpIcon or ChevronDownIcon next to sorted column
- On click, toggle direction or set new column

**Table styling (match DocumentTable):**
- overflow-hidden rounded-lg border border-text-muted/20
- thead: bg-surface/50
- th: px-4 py-3 text-xs font-medium text-text-muted uppercase tracking-wider
- tbody: divide-y divide-text-muted/10
- tr: hover:bg-surface/30 transition-colors
- td: px-4 py-3 text-sm

**Loading state:**
Show skeleton rows (4 rows) similar to DocumentTable.

**Empty state:**
Return null if transactions.length === 0 and not loading (page handles empty message).

**Implementation:**
```tsx
function SortHeader({ column, label, sortColumn, sortDirection, onSort }) {
  const isActive = sortColumn === column;
  return (
    <th
      onClick={() => onSort(column)}
      className="cursor-pointer select-none px-4 py-3 text-start text-xs font-medium text-text-muted uppercase tracking-wider"
    >
      <div className="flex items-center gap-1">
        {label}
        {isActive && (
          sortDirection === 'asc'
            ? <ChevronUpIcon className="w-4 h-4" />
            : <ChevronDownIcon className="w-4 h-4" />
        )}
      </div>
    </th>
  );
}
```

Format date: `new Intl.DateTimeFormat('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(new Date(tx.date))`

Import formatShekel from '@/lib/utils/currency', ChevronUpIcon/ChevronDownIcon from heroicons.
  </action>
  <verify>Table renders with transactions. Clicking headers triggers onSort. Amount colors are correct (green/red).</verify>
  <done>TransactionTable displays transactions with sortable headers, RTL-ready, income/expense color coding, loading skeleton</done>
</task>

<task type="auto">
  <name>Task 3: Integrate BankMovementsPage</name>
  <files>src/pages/BankMovementsPage.tsx</files>
  <action>
Replace the placeholder BankMovementsPage with full implementation.

**Implementation:**
1. Import useTransactions, BankUploader, TransactionFilters, TransactionTable
2. Use useState for filters and sort state
3. Implement client-side filtering and sorting

**State:**
```typescript
const [filters, setFilters] = useState<TransactionFilterState>({
  search: '',
  dateFrom: '',
  dateTo: '',
  type: 'all',
});
const [sortColumn, setSortColumn] = useState<keyof Transaction>('date');
const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
```

**Filtering logic:**
```typescript
const filteredTransactions = useMemo(() => {
  return transactions.filter((tx) => {
    // Search filter
    if (filters.search && !tx.description.toLowerCase().includes(filters.search.toLowerCase())) {
      return false;
    }
    // Date range
    if (filters.dateFrom && tx.date < filters.dateFrom) return false;
    if (filters.dateTo && tx.date > filters.dateTo) return false;
    // Type filter
    if (filters.type === 'income' && !tx.is_income) return false;
    if (filters.type === 'expense' && tx.is_income) return false;
    return true;
  });
}, [transactions, filters]);
```

**Sorting logic:**
```typescript
const sortedTransactions = useMemo(() => {
  return [...filteredTransactions].sort((a, b) => {
    let aVal = a[sortColumn];
    let bVal = b[sortColumn];

    // Handle dates
    if (sortColumn === 'date' || sortColumn === 'value_date') {
      aVal = aVal ? new Date(aVal as string).getTime() : 0;
      bVal = bVal ? new Date(bVal as string).getTime() : 0;
    }

    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });
}, [filteredTransactions, sortColumn, sortDirection]);
```

**Sort handler:**
```typescript
const handleSort = (column: keyof Transaction) => {
  if (column === sortColumn) {
    setSortDirection((d) => (d === 'asc' ? 'desc' : 'asc'));
  } else {
    setSortColumn(column);
    setSortDirection('desc');
  }
};
```

**Layout:**
```tsx
<div className="p-6 space-y-6">
  <h1 className="text-2xl font-bold text-text">Bank Movements</h1>

  {/* Upload section */}
  <div className="bg-surface rounded-lg p-6">
    <h2 className="text-lg font-semibold text-text mb-4">Import Bank Statement</h2>
    <BankUploader onUploadComplete={() => refetch()} />
  </div>

  {/* Transactions section */}
  <div className="bg-surface rounded-lg p-6">
    <h2 className="text-lg font-semibold text-text mb-4">
      Transactions
      {!isLoading && transactions.length > 0 && (
        <span className="text-sm font-normal text-text-muted ms-2">
          ({filteredTransactions.length} of {transactions.length})
        </span>
      )}
    </h2>

    {/* Filters - only show if there are transactions */}
    {transactions.length > 0 && (
      <div className="mb-4">
        <TransactionFilters filters={filters} onChange={setFilters} />
      </div>
    )}

    {/* Table or empty state */}
    {isLoading ? (
      <TransactionTable transactions={[]} isLoading sortColumn={sortColumn} sortDirection={sortDirection} onSort={handleSort} />
    ) : transactions.length === 0 ? (
      <p className="text-text-muted text-center py-8">
        No transactions yet. Import a bank statement above to get started.
      </p>
    ) : filteredTransactions.length === 0 ? (
      <p className="text-text-muted text-center py-8">
        No transactions match your filters.
      </p>
    ) : (
      <TransactionTable
        transactions={sortedTransactions}
        sortColumn={sortColumn}
        sortDirection={sortDirection}
        onSort={handleSort}
      />
    )}
  </div>
</div>
```

Call refetch() from useTransactions when upload completes to refresh the list.
  </action>
  <verify>Page renders with upload section and transaction section. After upload, transactions appear in table. Filters and sorting work. Hebrew text displays correctly.</verify>
  <done>BankMovementsPage shows BankUploader, TransactionFilters, TransactionTable. Client-side filtering/sorting works. Refetch on upload complete. Empty states handled.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. Navigate to /bank-movements in the app
3. Upload section visible with BankUploader
4. After importing a file, transactions appear in table
5. Filters work: search filters descriptions, date range filters dates, type filters income/expense
6. Sorting works: click column headers to sort
7. Hebrew descriptions display correctly (RTL)
8. Income amounts show green, expense amounts show red
</verification>

<success_criteria>
- [ ] TransactionFilters component has search, date range, type filter controls
- [ ] TransactionTable displays transactions with sortable headers
- [ ] Amount styling: green for income, red for expense
- [ ] Table has loading skeleton and handles empty state
- [ ] BankMovementsPage integrates BankUploader, filters, and table
- [ ] Client-side filtering and sorting work correctly
- [ ] Refetch after upload shows new transactions
- [ ] Hebrew text displays correctly with RTL support
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-bank-statement-import/05-03-SUMMARY.md`
</output>
