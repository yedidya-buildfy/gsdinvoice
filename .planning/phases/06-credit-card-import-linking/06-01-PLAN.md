---
phase: 06-credit-card-import-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/parsers/creditCardParser.ts
  - src/lib/parsers/index.ts
  - src/hooks/useCreditCardUpload.ts
  - src/hooks/useCreditCards.ts
autonomous: true

must_haves:
  truths:
    - "Credit card xlsx/csv files are parsed with correct column detection"
    - "Credit card transactions include merchant name, billing date, and card last four"
    - "Foreign currency amounts are parsed alongside ILS amounts"
    - "Duplicate credit card transactions are detected via hash"
  artifacts:
    - path: "src/lib/parsers/creditCardParser.ts"
      provides: "Credit card statement parser with Israeli column patterns"
      exports: ["parseCreditCardStatement", "ParsedCreditCardTransaction"]
    - path: "src/hooks/useCreditCardUpload.ts"
      provides: "Upload hook with file selection, parsing, duplicate detection"
      exports: ["useCreditCardUpload"]
    - path: "src/hooks/useCreditCards.ts"
      provides: "TanStack Query hook for credit card data"
      exports: ["useCreditCards", "useCreditCardTransactions"]
  key_links:
    - from: "src/hooks/useCreditCardUpload.ts"
      to: "src/lib/parsers/creditCardParser.ts"
      via: "import parseCreditCardStatement"
      pattern: "parseCreditCardStatement"
    - from: "src/hooks/useCreditCardUpload.ts"
      to: "supabase.transactions"
      via: "insert with type='credit_card'"
      pattern: "from\\('transactions'\\)"
---

<objective>
Create credit card statement parser and upload infrastructure that handles Israeli credit card formats with merchant details, foreign currency amounts, and card identifier extraction.

Purpose: Enable users to upload credit card statements (BANK-03) with the same parsing quality as bank statements, setting up for linking in subsequent plans.
Output: creditCardParser.ts, useCreditCardUpload.ts, useCreditCards.ts
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-credit-card-import-linking/06-RESEARCH.md

# Existing patterns to follow
@src/lib/parsers/bankStatementParser.ts
@src/hooks/useBankStatementUpload.ts
@src/hooks/useTransactions.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credit card statement parser</name>
  <files>src/lib/parsers/creditCardParser.ts, src/lib/parsers/index.ts</files>
  <action>
Create creditCardParser.ts following the exact pattern of bankStatementParser.ts but with credit card specific columns.

**ParsedCreditCardTransaction interface:**
```typescript
export interface ParsedCreditCardTransaction {
  date: string;                    // ISO YYYY-MM-DD (transaction date)
  billingDate: string | null;      // ISO YYYY-MM-DD (charge date)
  merchantName: string;            // Business name
  amountAgorot: number;            // ILS amount in agorot (always present)
  foreignAmount: number | null;    // Original amount if foreign currency
  foreignCurrency: string | null;  // 'USD', 'EUR', etc.
  cardLastFour: string;            // Last 4 digits of card
  transactionType: string | null;  // 'רגילה', 'הוראת קבע'
  notes: string | null;            // Raw notes field
}
```

**Column patterns for Israeli credit cards (from sample file פירוטי אשראי.xlsx):**
```typescript
const CREDIT_CARD_COLUMN_PATTERNS = {
  date: ['תאריך עסקה', 'תאריך'],
  billingDate: ['מועד חיוב', 'תאריך חיוב'],
  merchantName: ['שם בית עסק', 'בית עסק', 'שם בית העסק'],
  amountILS: ['סכום בש"ח', 'סכום בשקלים', 'סכום'],
  foreignAmount: ['סכום במטבע מקור', 'סכום בדולר', 'סכום במט"ח'],
  card: ['כרטיס', 'מספר כרטיס', '4 ספרות אחרונות'],
  transactionType: ['סוג עסקה'],
  notes: ['הערות', 'פרטים נוספים'],
};
```

**Implementation details:**
- Reuse normalizeHeader and detectHeaderRow from bank parser pattern
- Extract card last four digits using regex: match 4 consecutive digits, take last match
- Parse both ILS and foreign amounts when present
- Handle empty amountILS when foreignAmount exists (use 0 for amountAgorot, will be linked to bank charge for actual ILS)
- Generate hash from: `date|merchantName|amountAgorot|cardLastFour`

**Export from index.ts:**
Add exports for parseCreditCardStatement and ParsedCreditCardTransaction
  </action>
  <verify>
- npx tsc --noEmit passes
- src/lib/parsers/creditCardParser.ts exists with parseCreditCardStatement function
- src/lib/parsers/index.ts exports both bank and credit card parser functions
  </verify>
  <done>
Credit card parser correctly parses Israeli credit card statement formats with automatic column detection, foreign currency handling, and card identifier extraction
  </done>
</task>

<task type="auto">
  <name>Task 2: Create credit card upload hook and data query hooks</name>
  <files>src/hooks/useCreditCardUpload.ts, src/hooks/useCreditCards.ts</files>
  <action>
**useCreditCardUpload.ts:**
Follow useBankStatementUpload.ts pattern exactly:

1. Same state management: file, status, error, parsedCount, savedCount, duplicateCount
2. Same selectFile, processFile, reset callbacks
3. Key differences:
   - Import parseCreditCardStatement instead of parseBankStatement
   - Insert to transactions table with:
     - `transaction_type: 'credit_card'` (add this field conceptually - check if schema supports, otherwise use description prefix or notes)
     - `is_credit_card_charge: false` (these are the detail rows, not bank charges)
   - Auto-create credit_cards row on first upload for each unique cardLastFour
   - Link transaction to credit_cards.id via linked_credit_card_id

**Credit card auto-creation logic:**
```typescript
// For each unique cardLastFour in parsed transactions
const uniqueCards = [...new Set(parsedTransactions.map(tx => tx.cardLastFour))];

for (const cardLastFour of uniqueCards) {
  // Check if card exists
  const { data: existing } = await supabase
    .from('credit_cards')
    .select('id')
    .eq('user_id', user.id)
    .eq('card_last_four', cardLastFour)
    .single();

  if (!existing) {
    // Create new card
    await supabase.from('credit_cards').insert({
      user_id: user.id,
      card_last_four: cardLastFour,
      card_type: 'visa', // default, user can edit later
    });
  }
}
```

**Transaction insert mapping:**
```typescript
const insert: TransactionInsert = {
  user_id: user.id,
  date: tx.date,
  value_date: tx.billingDate,    // billing date as value_date
  description: tx.merchantName,   // merchant name as description
  reference: tx.transactionType,  // type as reference
  amount_agorot: tx.amountAgorot,
  is_income: tx.amountAgorot > 0,
  is_credit_card_charge: false,   // detail rows, not bank charges
  linked_credit_card_id: cardIdMap[tx.cardLastFour], // link to credit_cards table
  hash: utf8ToBase64(`cc|${tx.date}|${tx.merchantName}|${tx.amountAgorot}|${tx.cardLastFour}`),
  match_status: 'unmatched',
};
```

**useCreditCards.ts:**
Create TanStack Query hooks:

1. `useCreditCards()` - fetch all user's credit cards
2. `useCreditCardTransactions(cardId?: string)` - fetch credit card transactions, optionally filtered by card

Follow useTransactions.ts pattern with 30s staleTime.
  </action>
  <verify>
- npx tsc --noEmit passes
- src/hooks/useCreditCardUpload.ts exports useCreditCardUpload
- src/hooks/useCreditCards.ts exports useCreditCards and useCreditCardTransactions
  </verify>
  <done>
Upload hook handles credit card file selection, parsing, auto-creates credit_cards entries, and inserts transactions with proper linking
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. All new files exist in correct locations
3. Parser handles sample file format (if available for testing)
4. Hooks follow established patterns from Phase 5
</verification>

<success_criteria>
- Credit card parser recognizes Israeli credit card column formats
- Foreign currency amounts stored alongside ILS equivalents
- Card last four extracted and normalized
- Upload hook auto-creates credit_cards entries
- Transactions linked to credit_cards via foreign key
- Hash-based duplicate detection prevents re-importing same transactions
</success_criteria>

<output>
After completion, create `.planning/phases/06-credit-card-import-linking/06-01-SUMMARY.md`
</output>
