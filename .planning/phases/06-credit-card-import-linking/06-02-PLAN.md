---
phase: 06-credit-card-import-linking
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/services/creditCardLinker.ts
  - src/lib/parsers/bankStatementParser.ts
  - src/hooks/useBankStatementUpload.ts
  - src/components/creditcard/CreditCardTable.tsx
autonomous: true

must_haves:
  truths:
    - "Bank transactions with credit card keywords are flagged as is_credit_card_charge=true"
    - "Credit card transactions can be linked to bank charges by card and date"
    - "Linking uses amount tolerance (2%) and date window (2 days)"
  artifacts:
    - path: "src/lib/services/creditCardLinker.ts"
      provides: "Automatic linking of credit card transactions to bank charges"
      exports: ["linkCreditCardTransactions", "detectCreditCardCharge"]
    - path: "src/components/creditcard/CreditCardTable.tsx"
      provides: "Credit card transaction display with merchant details"
      exports: ["CreditCardTable"]
  key_links:
    - from: "src/hooks/useBankStatementUpload.ts"
      to: "src/lib/services/creditCardLinker.ts"
      via: "import detectCreditCardCharge"
      pattern: "detectCreditCardCharge"
    - from: "src/lib/services/creditCardLinker.ts"
      to: "supabase.transactions"
      via: "update linked_credit_card_id"
      pattern: "update\\(.*linked_credit_card_id"
---

<objective>
Create linking service that connects credit card transactions to bank charges using amount and date matching, and update bank uploader to flag credit card charges on import.

Purpose: Enable automatic linking (BANK-06) and credit card charge detection (BANK-05) so users can see which bank charges correspond to which credit card transactions.
Output: creditCardLinker.ts, updated bankStatementParser.ts, CreditCardTable.tsx
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-credit-card-import-linking/06-RESEARCH.md
@.planning/phases/06-credit-card-import-linking/06-01-SUMMARY.md

# Existing code to modify
@src/lib/parsers/bankStatementParser.ts
@src/hooks/useBankStatementUpload.ts
@src/components/bank/TransactionTable.tsx
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create credit card linking service with charge detection</name>
  <files>src/lib/services/creditCardLinker.ts</files>
  <action>
Create src/lib/services/creditCardLinker.ts with:

**1. detectCreditCardCharge function:**
```typescript
/**
 * Detect if a bank transaction description indicates a credit card charge
 * Returns the card last four if detected, null otherwise
 */
export function detectCreditCardCharge(description: string): string | null {
  const ccKeywords = [
    'כרטיס',           // card
    'ויזא',            // Visa
    'ויזה',            // Visa (alternative spelling)
    'visa',
    'מאסטרקארד',       // Mastercard
    'mastercard',
    'אמריקן אקספרס',   // American Express
    'amex',
    'ישראכרט',         // Isracard
    'לאומי קארד',      // Leumi Card
    'מקס',             // Max
    'כאל',             // Cal
    'חיוב לכרטיס',     // charge to card
  ];

  const normalized = description.toLowerCase();
  const isCC = ccKeywords.some(keyword => normalized.includes(keyword.toLowerCase()));

  if (!isCC) return null;

  // Extract card last four digits
  const matches = description.match(/\d{4}/g);
  return matches && matches.length > 0 ? matches[matches.length - 1] : null;
}
```

**2. Amount matching with tolerance:**
```typescript
interface AmountMatch {
  matches: boolean;
  difference: number;
  percentDiff: number;
}

function amountsMatch(
  amount1Agorot: number,
  amount2Agorot: number,
  tolerancePercent: number = 2
): AmountMatch {
  const diff = Math.abs(amount1Agorot - amount2Agorot);
  const larger = Math.max(Math.abs(amount1Agorot), Math.abs(amount2Agorot));
  const percentDiff = larger > 0 ? (diff / larger) * 100 : 0;

  return {
    matches: percentDiff <= tolerancePercent,
    difference: diff,
    percentDiff,
  };
}
```

**3. Date window matching:**
```typescript
function isWithinDateWindow(
  date1: string, // ISO YYYY-MM-DD
  date2: string, // ISO YYYY-MM-DD
  windowDays: number = 2
): boolean {
  const d1 = new Date(date1);
  const d2 = new Date(date2);
  const diffMs = Math.abs(d1.getTime() - d2.getTime());
  const diffDays = diffMs / (1000 * 60 * 60 * 24);
  return diffDays <= windowDays;
}
```

**4. Main linking function:**
```typescript
import { supabase } from '@/lib/supabase';

interface LinkingResult {
  linked: number;
  unlinked: number;
  errors: string[];
}

export async function linkCreditCardTransactions(
  userId: string,
  cardId?: string // optional - link all cards if not specified
): Promise<LinkingResult> {
  const result: LinkingResult = { linked: 0, unlinked: 0, errors: [] };

  try {
    // 1. Fetch unlinked credit card transactions
    let ccQuery = supabase
      .from('transactions')
      .select('*')
      .eq('user_id', userId)
      .eq('is_credit_card_charge', false)
      .not('linked_credit_card_id', 'is', null)
      .is('linked_bank_charge_id', null); // not yet linked to bank charge

    // Note: We need to track which CC transaction is linked to which bank charge
    // This requires storing the link. Since transactions already have linked_credit_card_id,
    // we can use a different approach:
    // - CC transactions have linked_credit_card_id (which card they belong to)
    // - Bank charges have is_credit_card_charge=true and we need to link them

    // Actually, the linking is: bank charge -> credit card detail rows
    // So bank charges should store linked_credit_card_id pointing to credit_cards.id

    // Revised approach:
    // 1. Fetch bank charges (is_credit_card_charge=true) without linked_credit_card_id
    // 2. For each bank charge, find matching credit card by:
    //    - Card last four (from description)
    //    - Date within 2 days of billing date
    // 3. Update bank charge with linked_credit_card_id

    // Fetch bank charges needing linking
    const { data: bankCharges, error: bankError } = await supabase
      .from('transactions')
      .select('*')
      .eq('user_id', userId)
      .eq('is_credit_card_charge', true)
      .is('linked_credit_card_id', null);

    if (bankError) {
      result.errors.push(`Failed to fetch bank charges: ${bankError.message}`);
      return result;
    }

    if (!bankCharges || bankCharges.length === 0) {
      return result; // Nothing to link
    }

    // Fetch user's credit cards
    const { data: cards, error: cardsError } = await supabase
      .from('credit_cards')
      .select('*')
      .eq('user_id', userId);

    if (cardsError || !cards) {
      result.errors.push(`Failed to fetch credit cards: ${cardsError?.message}`);
      return result;
    }

    // Create lookup by card last four
    const cardsByLastFour = new Map(cards.map(c => [c.card_last_four, c]));

    // Link each bank charge to appropriate credit card
    for (const charge of bankCharges) {
      const cardLastFour = detectCreditCardCharge(charge.description);
      if (!cardLastFour) {
        result.unlinked++;
        continue;
      }

      const card = cardsByLastFour.get(cardLastFour);
      if (!card) {
        result.unlinked++;
        continue;
      }

      // Update bank charge with credit card link
      const { error: updateError } = await supabase
        .from('transactions')
        .update({ linked_credit_card_id: card.id })
        .eq('id', charge.id);

      if (updateError) {
        result.errors.push(`Failed to link charge ${charge.id}: ${updateError.message}`);
        result.unlinked++;
      } else {
        result.linked++;
      }
    }

    return result;
  } catch (err) {
    result.errors.push(err instanceof Error ? err.message : 'Unknown error');
    return result;
  }
}
```
  </action>
  <verify>
- npx tsc --noEmit passes
- src/lib/services/creditCardLinker.ts exists
- detectCreditCardCharge function exported
- linkCreditCardTransactions function exported
  </verify>
  <done>
Credit card linking service detects CC charges in bank descriptions and links them to credit_cards entries
  </done>
</task>

<task type="auto">
  <name>Task 2: Update bank uploader to flag credit card charges</name>
  <files>src/hooks/useBankStatementUpload.ts</files>
  <action>
Modify useBankStatementUpload.ts to detect and flag credit card charges during import:

1. Import detectCreditCardCharge from creditCardLinker:
```typescript
import { detectCreditCardCharge } from '@/lib/services/creditCardLinker';
```

2. Update transaction insert mapping to set is_credit_card_charge:
```typescript
const inserts: TransactionInsert[] = newTransactions.map(({ tx, hash }) => {
  const cardLastFour = detectCreditCardCharge(tx.description);

  return {
    user_id: user.id,
    date: tx.date,
    value_date: tx.valueDate,
    description: tx.description,
    reference: tx.reference,
    amount_agorot: tx.amountAgorot,
    balance_agorot: tx.balanceAgorot,
    is_income: tx.amountAgorot > 0,
    is_credit_card_charge: cardLastFour !== null, // FLAG: true if CC charge detected
    source_file_id: null,
    hash: hash,
    match_status: 'unmatched',
  };
});
```

This ensures that when bank statements are imported, credit card charges are automatically flagged for later linking.
  </action>
  <verify>
- npx tsc --noEmit passes
- useBankStatementUpload imports detectCreditCardCharge
- is_credit_card_charge is set based on description detection
  </verify>
  <done>
Bank statement import automatically flags credit card charges based on description keywords
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CreditCardTable component</name>
  <files>src/components/creditcard/CreditCardTable.tsx</files>
  <action>
Create src/components/creditcard/CreditCardTable.tsx following TransactionTable.tsx pattern:

**Key differences from TransactionTable:**
1. Different columns: Date, Merchant, Amount, Card, Billing Date, Type
2. Show linked status (linked to bank charge or not)
3. Card column shows last 4 digits
4. Merchant name in description column

**Component interface:**
```typescript
interface CreditCardTableProps {
  transactions: Transaction[];
  isLoading?: boolean;
  sortColumn: keyof Transaction;
  sortDirection: 'asc' | 'desc';
  onSort: (column: keyof Transaction) => void;
  selectedIds?: Set<string>;
  onSelectionChange?: (ids: Set<string>) => void;
}
```

**Table columns:**
1. Checkbox (selection)
2. תאריך (Date) - transaction date, sortable
3. בית עסק (Merchant) - description field, RTL, sortable
4. סכום (Amount) - amount_agorot formatted, green/red, sortable
5. כרטיס (Card) - extract from linked_credit_card_id lookup or description
6. מועד חיוב (Billing Date) - value_date field
7. סטטוס (Status) - linked/unlinked indicator

**Implementation notes:**
- Use same SortHeader pattern from TransactionTable
- Same RTL styling (text-end, dir="auto")
- Same loading skeleton pattern
- Same selection checkbox pattern
- Green for income, red for expense
- Show icon indicator for linked status (CheckCircleIcon for linked, clock/pending for unlinked)
  </action>
  <verify>
- npx tsc --noEmit passes
- src/components/creditcard/CreditCardTable.tsx exists
- CreditCardTable component exported
  </verify>
  <done>
CreditCardTable displays credit card transactions with merchant details, card info, and linked status
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Bank uploader flags CC charges on import
3. Linking service correctly matches cards by last four digits
4. CreditCardTable displays transactions with proper RTL layout
</verification>

<success_criteria>
- detectCreditCardCharge identifies Israeli credit card keywords
- Bank imports flag is_credit_card_charge=true for CC transactions
- Linking service connects bank charges to credit_cards entries
- CreditCardTable follows TransactionTable patterns for consistency
- Amount tolerance and date window matching work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-credit-card-import-linking/06-02-SUMMARY.md`
</output>
