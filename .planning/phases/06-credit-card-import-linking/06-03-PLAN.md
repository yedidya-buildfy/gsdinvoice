---
phase: 06-credit-card-import-linking
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/components/creditcard/CreditCardUploader.tsx
  - src/pages/CreditCardPage.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can upload credit card statement from Credit Card page"
    - "Credit card transactions display in sortable, filterable table"
    - "User can trigger re-linking of transactions"
    - "Credit Card page accessible from sidebar navigation"
  artifacts:
    - path: "src/components/creditcard/CreditCardUploader.tsx"
      provides: "Credit card file upload UI with drag/drop"
      exports: ["CreditCardUploader"]
    - path: "src/pages/CreditCardPage.tsx"
      provides: "Complete credit card management page"
      exports: ["CreditCardPage"]
  key_links:
    - from: "src/pages/CreditCardPage.tsx"
      to: "src/hooks/useCreditCardUpload.ts"
      via: "import useCreditCardUpload"
      pattern: "useCreditCardUpload"
    - from: "src/pages/CreditCardPage.tsx"
      to: "src/components/creditcard/CreditCardTable.tsx"
      via: "import CreditCardTable"
      pattern: "CreditCardTable"
    - from: "src/App.tsx"
      to: "src/pages/CreditCardPage.tsx"
      via: "route configuration"
      pattern: "CreditCardPage"
---

<objective>
Create complete Credit Card page with upload functionality, transaction display, and re-link action for manual retry of automatic linking.

Purpose: Provide users with a dedicated interface for managing credit card statements (BANK-03) and viewing linked transactions (BANK-05, BANK-06).
Output: CreditCardUploader.tsx, CreditCardPage.tsx, updated App.tsx routing
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-credit-card-import-linking/06-RESEARCH.md
@.planning/phases/06-credit-card-import-linking/06-01-SUMMARY.md

# Existing patterns to follow
@src/components/bank/BankUploader.tsx
@src/pages/BankMovementsPage.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CreditCardUploader component</name>
  <files>src/components/creditcard/CreditCardUploader.tsx</files>
  <action>
Create src/components/creditcard/CreditCardUploader.tsx following BankUploader.tsx pattern exactly:

1. Same drop zone UI with drag/drop handling
2. Same status display (idle, parsing, saving, success, error)
3. Use CreditCardIcon from @heroicons/react/24/outline instead of TableCellsIcon
4. Same file type acceptance (.xlsx, .csv)
5. Import and use useCreditCardUpload hook

**Key differences from BankUploader:**
- Icon: CreditCardIcon
- Text: "Drag credit card statement or click to browse"
- Uses useCreditCardUpload instead of useBankStatementUpload

**Interface:**
```typescript
interface CreditCardUploaderProps {
  onUploadComplete?: () => void;
}
```

Copy the structure of BankUploader.tsx and make these minimal changes:
- Import { CreditCardIcon } instead of { TableCellsIcon }
- Import { useCreditCardUpload } instead of { useBankStatementUpload }
- Change icon in JSX to CreditCardIcon
- Change text from "bank statement" to "credit card statement"
  </action>
  <verify>
- npx tsc --noEmit passes
- src/components/creditcard/CreditCardUploader.tsx exists
- CreditCardUploader component exported
  </verify>
  <done>
CreditCardUploader provides drag/drop upload UI for credit card statements
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CreditCardPage with upload and display</name>
  <files>src/pages/CreditCardPage.tsx</files>
  <action>
Create src/pages/CreditCardPage.tsx following BankMovementsPage.tsx pattern:

**Page structure:**
1. Page title: "Credit Card"
2. Upload section with CreditCardUploader
3. Card selector (if multiple cards exist)
4. Filters (reuse TransactionFilters or create similar)
5. CreditCardTable for transaction display
6. Re-link button to manually trigger linking

**Imports:**
```typescript
import { useState, useMemo } from 'react';
import { ArrowPathIcon, LinkIcon, TrashIcon } from '@heroicons/react/24/outline';
import { useCreditCards, useCreditCardTransactions } from '@/hooks/useCreditCards';
import { CreditCardUploader } from '@/components/creditcard/CreditCardUploader';
import { CreditCardTable } from '@/components/creditcard/CreditCardTable';
import { TransactionFilters, type TransactionFilterState } from '@/components/bank/TransactionFilters';
import { linkCreditCardTransactions } from '@/lib/services/creditCardLinker';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/lib/supabase';
import type { Transaction } from '@/types/database';
```

**State:**
```typescript
const { user } = useAuth();
const { cards, isLoading: cardsLoading } = useCreditCards();
const [selectedCardId, setSelectedCardId] = useState<string | null>(null);
const { transactions, isLoading, refetch } = useCreditCardTransactions(selectedCardId);

const [filters, setFilters] = useState<TransactionFilterState>({
  search: '',
  dateFrom: '',
  dateTo: '',
  type: 'all',
});

const [sortColumn, setSortColumn] = useState<keyof Transaction>('date');
const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
const [isLinking, setIsLinking] = useState(false);
const [isDeleting, setIsDeleting] = useState(false);
```

**Re-link handler:**
```typescript
const handleRelink = async () => {
  if (!user) return;
  setIsLinking(true);
  try {
    const result = await linkCreditCardTransactions(user.id, selectedCardId || undefined);
    console.log('[CreditCard] Linking result:', result);
    refetch();
  } catch (err) {
    console.error('[CreditCard] Linking error:', err);
  } finally {
    setIsLinking(false);
  }
};
```

**Card selector UI (above filters):**
```tsx
{cards && cards.length > 0 && (
  <div className="flex items-center gap-4 mb-4">
    <label className="text-sm text-text-muted">Filter by card:</label>
    <select
      value={selectedCardId || 'all'}
      onChange={(e) => setSelectedCardId(e.target.value === 'all' ? null : e.target.value)}
      className="px-3 py-2 bg-background border border-text-muted/20 rounded-lg text-text"
    >
      <option value="all">All Cards</option>
      {cards.map((card) => (
        <option key={card.id} value={card.id}>
          {card.card_name || `****${card.card_last_four}`}
        </option>
      ))}
    </select>
  </div>
)}
```

**Re-link button (in header, next to delete button):**
```tsx
<button
  type="button"
  onClick={handleRelink}
  disabled={isLinking}
  className="inline-flex items-center gap-2 px-4 py-2 bg-primary/20 text-primary rounded-lg hover:bg-primary/30 transition-colors disabled:opacity-50"
>
  {isLinking ? (
    <ArrowPathIcon className="w-4 h-4 animate-spin" />
  ) : (
    <LinkIcon className="w-4 h-4" />
  )}
  {isLinking ? 'Linking...' : 'Re-link Transactions'}
</button>
```

**Page layout:**
Same as BankMovementsPage - upload section at top, filters, then table.
  </action>
  <verify>
- npx tsc --noEmit passes
- src/pages/CreditCardPage.tsx exists
- CreditCardPage component exported
- Page includes upload, card selector, filters, table, and re-link button
  </verify>
  <done>
CreditCardPage provides complete interface for credit card statement management with upload, display, and re-linking
  </done>
</task>

<task type="auto">
  <name>Task 3: Update App.tsx routing for Credit Card page</name>
  <files>src/App.tsx</files>
  <action>
Update src/App.tsx to add route for CreditCardPage:

1. Import CreditCardPage:
```typescript
import { CreditCardPage } from '@/pages/CreditCardPage';
```

2. Add route within protected routes (alongside bank-movements, documents):
The Credit Card page should be at `/credit-card` path.

Find the existing protected routes section and add:
```tsx
<Route path="credit-card" element={<CreditCardPage />} />
```

This route should be alongside:
- dashboard (index)
- bank-movements
- documents
- settings

The sidebar already has "Credit Card" as a navigation item (from Phase 3), so this connects the route to it.
  </action>
  <verify>
- npx tsc --noEmit passes
- App.tsx imports CreditCardPage
- Route for /credit-card exists in protected routes
- Clicking Credit Card in sidebar navigates to the page
  </verify>
  <done>
Credit Card page accessible via sidebar navigation at /credit-card route
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Credit Card page loads at /credit-card route
3. Upload functionality works (file selection, parsing, saving)
4. Transaction table displays with proper columns
5. Card selector filters transactions by card
6. Re-link button triggers linking service
</verification>

<success_criteria>
- User can navigate to Credit Card page from sidebar
- User can upload credit card statement via drag/drop or browse
- Uploaded transactions appear in filterable, sortable table
- Card selector allows filtering by specific card
- Re-link button manually triggers the linking process
- Page follows same patterns as Bank Movements page for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/06-credit-card-import-linking/06-03-SUMMARY.md`
</output>
