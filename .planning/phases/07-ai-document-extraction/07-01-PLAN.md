---
phase: 07-ai-document-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/extract-invoice/index.ts
  - supabase/functions/extract-invoice/config.toml
autonomous: true
user_setup:
  - service: gemini
    why: "AI-powered invoice data extraction"
    env_vars:
      - name: GEMINI_API_KEY
        source: "Google AI Studio -> Get API key -> Create API key"
    dashboard_config:
      - task: "Set secret in Supabase"
        location: "Run: supabase secrets set GEMINI_API_KEY=your_key"

must_haves:
  truths:
    - "Edge Function accepts file_id, storage_path, and file_type parameters"
    - "Function downloads file from Supabase Storage and converts to base64"
    - "Function calls Gemini 3 Flash with structured output schema"
    - "Function extracts vendor_name, invoice_number, invoice_date, amounts, VAT, and confidence"
    - "Function stores extraction result in invoices table with file_id reference"
    - "Function updates files table status to 'extracted' or 'error'"
  artifacts:
    - path: "supabase/functions/extract-invoice/index.ts"
      provides: "Deno Edge Function for Gemini API extraction"
      min_lines: 100
    - path: "supabase/functions/extract-invoice/config.toml"
      provides: "Function timeout and runtime configuration"
      contains: "timeout = 120"
  key_links:
    - from: "supabase/functions/extract-invoice/index.ts"
      to: "Supabase Storage"
      via: "supabase.storage.from('documents').download()"
      pattern: "storage.*from.*documents.*download"
    - from: "supabase/functions/extract-invoice/index.ts"
      to: "invoices table"
      via: "supabase.from('invoices').insert()"
      pattern: "from.*invoices.*insert"
    - from: "supabase/functions/extract-invoice/index.ts"
      to: "Gemini API"
      via: "ai.models.generateContent()"
      pattern: "generateContent"
---

<objective>
Create the Supabase Edge Function that handles AI-powered invoice extraction using Gemini 3 Flash.

Purpose: This is the secure backend that keeps the Gemini API key server-side while providing structured data extraction from uploaded invoices. The function downloads documents from Storage, sends them to Gemini with a Zod-based schema, and stores the extracted data.

Output: Deployable Edge Function with proper CORS handling, error handling, and database integration.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ai-document-extraction/07-RESEARCH.md

# Existing codebase patterns
@src/types/database.ts
@src/lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Edge Function configuration</name>
  <files>supabase/functions/extract-invoice/config.toml</files>
  <action>
Create the Edge Function configuration file with:
- timeout = 120 (2 minutes for large documents, as recommended in research)
- deno_version = "2.1" (latest stable runtime)

This is a minimal TOML config file following Supabase Edge Function conventions.
  </action>
  <verify>File exists at supabase/functions/extract-invoice/config.toml with correct timeout setting</verify>
  <done>config.toml exists with 120s timeout and Deno 2.1 runtime specified</done>
</task>

<task type="auto">
  <name>Task 2: Create Edge Function for invoice extraction</name>
  <files>supabase/functions/extract-invoice/index.ts</files>
  <action>
Create the main Edge Function that:

1. **Imports** (using npm: specifier for Deno):
   - `GoogleGenAI` from "npm:@google/genai"
   - `createClient` from "npm:@supabase/supabase-js@2"
   - `z` from "npm:zod"
   - `zodToJsonSchema` from "npm:zod-to-json-schema"

2. **Define InvoiceExtractionSchema** using Zod with fields:
   - vendor_name: string().nullable() - Business/vendor name
   - invoice_number: string().nullable() - Invoice or receipt number
   - invoice_date: string().nullable() - Date in YYYY-MM-DD format
   - subtotal: number().nullable() - Amount before tax
   - vat_amount: number().nullable() - VAT/tax amount
   - total_amount: number().nullable() - Total including tax
   - currency: enum(["ILS", "USD", "EUR", "GBP"]).default("ILS")
   - confidence: number().min(0).max(100) - Extraction confidence 0-100
   - line_items: array of {description, quantity, unit_price, total} - all nullable

3. **CORS headers** for cross-origin requests:
   - Access-Control-Allow-Origin: "*"
   - Access-Control-Allow-Headers: "authorization, x-client-info, apikey, content-type"

4. **Main handler** (Deno.serve):
   - Handle OPTIONS preflight requests
   - Parse request body: { file_id, storage_path, file_type }
   - Initialize GoogleGenAI with GEMINI_API_KEY from Deno.env
   - Initialize Supabase with service role key (auto-injected)

5. **Processing flow**:
   - Update files.status to "processing"
   - Download file from Storage using supabase.storage.from("documents").download()
   - Convert ArrayBuffer to base64 using btoa + Uint8Array pattern
   - Determine MIME type: pdf -> application/pdf, png -> image/png, else image/jpeg

6. **Gemini API call**:
   - Model: "gemini-3-flash-preview"
   - Contents: inlineData with base64 + mimeType, then text prompt
   - Prompt must include: "The document may be in Hebrew or English"
   - Config: responseMimeType: "application/json", responseJsonSchema from zodToJsonSchema

7. **Store extraction result**:
   - Get user_id from files table
   - Convert amounts to agorot (multiply by 100, round)
   - Insert into invoices table with all extracted fields
   - Set invoices.status to "pending_review"
   - Insert line_items into invoice_rows if present
   - Update files.status to "extracted", set extracted_data JSON, set processed_at

8. **Error handling**:
   - Wrap in try/catch
   - On error: update files.status to "error", set error_message
   - Return JSON with success: false and error message

9. **Return format**:
   - Success: { success: true, invoice_id, confidence }
   - Error: { success: false, error: message }
  </action>
  <verify>
File compiles with valid TypeScript/Deno syntax. Check with:
- Review that all imports use npm: prefix for Deno compatibility
- Verify Zod schema matches invoices table structure from database.ts
- Confirm CORS headers present for browser requests
  </verify>
  <done>
Edge Function index.ts exists with:
- Zod schema for invoice extraction
- CORS handling for OPTIONS and POST
- File download from Storage
- Base64 conversion for Gemini
- Structured output with zodToJsonSchema
- Database updates for both files and invoices tables
- Proper error handling with status updates
  </done>
</task>

</tasks>

<verification>
1. Edge Function files exist in supabase/functions/extract-invoice/
2. config.toml has 120s timeout
3. index.ts has all required imports with npm: prefix
4. Zod schema matches database schema (amounts in agorot)
5. CORS headers present
6. Error handling updates file status
7. Hebrew language hint in prompt
</verification>

<success_criteria>
- Edge Function code ready for deployment
- Matches patterns from 07-RESEARCH.md
- Handles PDF and image files
- Stores extracted data in invoices table with file_id link
- Updates file status throughout processing lifecycle
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-document-extraction/07-01-SUMMARY.md`
</output>
