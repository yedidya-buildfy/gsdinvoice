---
phase: 07-ai-document-extraction
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - src/components/documents/ExtractionStatus.tsx
  - src/components/documents/DocumentTable.tsx
  - src/pages/InvoicesPage.tsx
autonomous: false

must_haves:
  truths:
    - "User can see extraction status for each document (pending, processing, extracted, error)"
    - "User can trigger extraction on selected documents via Extract button"
    - "Extracted invoices display in a separate section with extracted data"
    - "Confidence score displays as percentage with visual indicator"
    - "Hebrew vendor names display correctly (RTL)"
  artifacts:
    - path: "src/components/documents/ExtractionStatus.tsx"
      provides: "Status badge component showing extraction state"
      min_lines: 40
    - path: "src/components/documents/DocumentTable.tsx"
      provides: "Updated table with extraction status column"
      contains: "ExtractionStatus"
    - path: "src/pages/InvoicesPage.tsx"
      provides: "Updated page with Extract button and invoices section"
      contains: "useExtractDocument"
  key_links:
    - from: "src/pages/InvoicesPage.tsx"
      to: "useExtractDocument"
      via: "mutation hook for extraction"
      pattern: "useExtract.*mutate"
    - from: "src/components/documents/DocumentTable.tsx"
      to: "ExtractionStatus"
      via: "status column render"
      pattern: "<ExtractionStatus"
---

<objective>
Integrate extraction UI into the Invoices page with status indicators and an Extract button.

Purpose: Allow users to trigger AI extraction on uploaded documents and see the extraction progress and results. The UI should clearly show which documents have been processed, which are pending, and any errors.

Output: Updated InvoicesPage with extraction workflow, status indicators in document table, and extracted invoices display.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ai-document-extraction/07-RESEARCH.md
@.planning/phases/07-ai-document-extraction/07-02-PLAN.md

# Existing UI patterns
@src/components/documents/DocumentTable.tsx
@src/components/documents/DocumentList.tsx
@src/pages/InvoicesPage.tsx
@src/styles/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExtractionStatus component</name>
  <files>src/components/documents/ExtractionStatus.tsx</files>
  <action>
Create a status badge component using HeroIcons (outline, thin style per CLAUDE.md):

1. **Imports**:
   - ArrowPathIcon, CheckCircleIcon, ExclamationCircleIcon, ClockIcon from @heroicons/react/24/outline
   - ExtractionStatus type from @/lib/extraction/types

2. **Props interface**:
   - status: ExtractionStatus ("pending" | "processing" | "extracted" | "error")
   - confidence?: number | null
   - errorMessage?: string | null

3. **Status config object** mapping status to:
   - icon: the appropriate HeroIcon component
   - label: Hebrew text (ממתין, מעבד, הושלם, שגיאה)
   - color: Tailwind classes (text-X bg-X/10 pattern)
   - animate: boolean (true for processing to spin icon)

4. **Component render**:
   - Outer div with flex items-center gap-2
   - Badge span with:
     - Inline-flex items-center gap-1
     - px-2 py-1 rounded-full text-xs font-medium
     - Dynamic color classes from config
   - Icon with w-3.5 h-3.5, add animate-spin if config.animate
   - Label text
   - If status === "extracted" and confidence !== null:
     - Show span with "X% confidence" (use text-text-muted)
   - If status === "error" and errorMessage:
     - Show truncated error (first 30 chars) with title attribute for full message

Use existing color patterns from globals.css (text-text-muted, etc.).
  </action>
  <verify>Component renders correctly for all four status states. Icons use HeroIcons outline style.</verify>
  <done>ExtractionStatus.tsx exists with status badge, icon, label, confidence display, and error tooltip</done>
</task>

<task type="auto">
  <name>Task 2: Update DocumentTable with extraction status</name>
  <files>src/components/documents/DocumentTable.tsx</files>
  <action>
Modify DocumentTable to include extraction status column:

1. **Import** ExtractionStatus component from ./ExtractionStatus

2. **Add new column** to table header:
   - Position: After "Status" or as last column before actions
   - Header: "AI Status" or "חילוץ" (Extraction in Hebrew)

3. **Add status cell** to each row:
   - Map file.status to ExtractionStatus component
   - Pass status, confidence from file.extracted_data?.confidence if available
   - Pass errorMessage from file.error_message

4. **Handle typing**:
   - The file.status field is string, cast or validate to ExtractionStatus type
   - Default to "pending" if status not recognized

Keep existing table structure intact. The DocumentTable already has checkbox selection, thumbnail, name, type, size, and date columns.
  </action>
  <verify>
DocumentTable renders with new extraction status column. Status shows for each document row.
  </verify>
  <done>DocumentTable shows extraction status column with ExtractionStatus component for each row</done>
</task>

<task type="auto">
  <name>Task 3: Update InvoicesPage with Extract button and invoices section</name>
  <files>src/pages/InvoicesPage.tsx</files>
  <action>
Update InvoicesPage to add extraction workflow:

1. **New imports**:
   - useExtractDocument, useExtractMultipleDocuments from @/hooks/useDocumentExtraction
   - useInvoices from @/hooks/useInvoices
   - SparklesIcon from @heroicons/react/24/outline (for Extract button)
   - formatAgorot from @/lib/utils/currency (for displaying amounts)

2. **Add extraction mutation**:
   - const extractDocument = useExtractDocument()
   - const extractMultiple = useExtractMultipleDocuments()
   - const { data: invoices } = useInvoices()

3. **Add Extract button** next to Delete button in action bar:
   - Only show when selectedIds.size > 0
   - Button with SparklesIcon and "Extract (N)" text
   - Disabled when extractMultiple.isPending
   - onClick handler:
     a. Get selected documents from documents array
     b. Filter to only pending status (not already extracted)
     c. Map to ExtractionRequest objects: { fileId: doc.id, storagePath: doc.storage_path, fileType: doc.file_type }
     d. Call extractMultiple.mutate(requests)

4. **Add Extracted Invoices section** below Documents section:
   - h2: "Extracted Invoices" / "חשבוניות שחולצו"
   - Count badge showing invoices?.length
   - Simple table or card list showing:
     - Vendor name (RTL)
     - Invoice number
     - Date (formatted)
     - Total amount (formatted in ILS using formatAgorot)
     - Confidence score with color (green >80%, yellow 50-80%, red <50%)
     - Status badge
   - Empty state if no invoices

5. **Style the Extract button**:
   - bg-primary/20 text-primary (matches the green accent theme)
   - hover:bg-primary/30
   - Consistent sizing with Delete button
  </action>
  <verify>
Run dev server and test:
1. Extract button appears when documents selected
2. Clicking Extract triggers the mutation (check network tab)
3. Invoices section shows extracted data
4. RTL text displays correctly
  </verify>
  <done>
InvoicesPage has:
- Extract button that triggers batch extraction
- Extracted invoices section displaying results
- Confidence score visualization
- Proper loading/disabled states
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete AI extraction workflow:
- Edge Function for Gemini 3 Flash extraction
- Client hooks for triggering extraction
- UI with Extract button and status indicators
- Invoices display section
  </what-built>
  <how-to-verify>
PREREQUISITES: Before testing, you need to:
1. Set Gemini API key: `supabase secrets set GEMINI_API_KEY=your_key`
2. Deploy Edge Function: `supabase functions deploy extract-invoice`

TESTING:
1. Upload a sample invoice (PDF or image)
2. Select the document and click "Extract"
3. Watch status change: pending -> processing -> extracted
4. Verify extracted data appears in Invoices section
5. Check that Hebrew vendor names display correctly (RTL)
6. Verify confidence score shows as percentage

EXPECTED BEHAVIOR:
- Upload completes with status "pending"
- Extract button triggers processing
- After 5-30 seconds, status shows "extracted"
- Vendor name, date, amount, VAT visible in extracted data
- Confidence score between 0-100%
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found during testing</resume-signal>
</task>

</tasks>

<verification>
1. ExtractionStatus component displays all four states correctly
2. DocumentTable shows extraction status for each document
3. Extract button visible and functional when documents selected
4. Extraction triggers Edge Function call
5. Invoices section populates after extraction completes
6. Hebrew text renders correctly in RTL
7. Amounts display in ILS format
</verification>

<success_criteria>
- User can select documents and click Extract
- Status updates visually during processing
- Extracted data displays with all fields (vendor, date, amount, VAT, invoice#)
- Confidence score visible (0-100%)
- Hebrew text correctly extracted and displayed
- Error states handled gracefully with message display
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-document-extraction/07-03-SUMMARY.md`
</output>
