---
phase: 08-credit-card-to-bank-matching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/services/billingDateMatcher.ts
  - src/lib/services/creditCardLinker.ts
autonomous: true

must_haves:
  truths:
    - "System matches CC transactions to bank charges by billing date and card number"
    - "Matching respects configurable date tolerance from settings"
    - "Card last four is extracted from bank description"
  artifacts:
    - path: "src/lib/services/billingDateMatcher.ts"
      provides: "Billing date matching service"
      exports: ["matchByBillingDate", "getBillingDateGroups", "BillingDateGroup"]
    - path: "src/lib/services/creditCardLinker.ts"
      provides: "Updated linker using billing date approach"
      exports: ["linkCreditCardTransactions", "detectCreditCardCharge"]
  key_links:
    - from: "src/lib/services/billingDateMatcher.ts"
      to: "settingsStore"
      via: "imports ccBankDateRangeDays"
      pattern: "ccBankDateRangeDays"
    - from: "src/lib/services/billingDateMatcher.ts"
      to: "transactions table"
      via: "supabase query"
      pattern: "supabase.*from.*transactions"
---

<objective>
Implement billing-date based matching service for linking credit card transactions to bank charges.

Purpose: Replace the current amount/date fuzzy matching with the user's requested simple approach - match CC transactions to bank charges using the billing date (moed hiuv) column and card last four digits extracted from bank descriptions.

Output: New billingDateMatcher.ts service and updated creditCardLinker.ts that uses billing date matching instead of amount tolerance.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/services/creditCardLinker.ts
@src/stores/settingsStore.ts
@src/types/database.ts
@src/hooks/useCreditCardUpload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing date matcher service</name>
  <files>src/lib/services/billingDateMatcher.ts</files>
  <action>
Create a new service file `billingDateMatcher.ts` with:

1. **Interface `BillingDateGroup`:**
   ```typescript
   interface BillingDateGroup {
     billingDate: string // YYYY-MM-DD
     cardLastFour: string
     cardId: string | null
     bankChargeId: string | null
     bankChargeAmount: number // in agorot
     ccTransactionIds: string[]
     ccTransactionsTotal: number // sum of CC transaction amounts in agorot
     discrepancy: number // bankChargeAmount - ccTransactionsTotal (positive = missing, negative = over)
   }
   ```

2. **Function `getBillingDateGroups(userId: string, dateRangeDays: number)`:**
   - Fetch all CC transactions (is_credit_card_charge=false, linked_credit_card_id NOT NULL) with their value_date (billing date)
   - Fetch all bank CC charges (is_credit_card_charge=true)
   - Group CC transactions by (value_date, cardLastFour)
   - For each group, find matching bank charge where:
     - Bank description contains card last four (use existing detectCreditCardCharge)
     - Bank date is within value_date +/- dateRangeDays
   - Calculate discrepancy for each group
   - Return array of BillingDateGroup

3. **Function `matchByBillingDate(userId: string, dateRangeDays: number)`:**
   - Similar to getBillingDateGroups but returns match result
   - Updates bank charges with linked_credit_card_id where matches found
   - Returns { matched: number, unmatched: number, errors: string[] }

Key implementation notes:
- Use value_date field for CC transaction billing date (already populated by upload hook)
- Extract card last four from bank description using existing detectCreditCardCharge function
- Amount is NOT used for matching - only billing date and card number
- The bank charge will have different amount than sum of CC transactions (that's expected and shown as discrepancy)
  </action>
  <verify>
File exists at src/lib/services/billingDateMatcher.ts with:
- BillingDateGroup interface exported
- getBillingDateGroups function exported
- matchByBillingDate function exported
- TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>
billingDateMatcher.ts service created with billing date grouping and matching logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update creditCardLinker to use billing date matching</name>
  <files>src/lib/services/creditCardLinker.ts</files>
  <action>
Update the existing creditCardLinker.ts to use the new billing date approach:

1. **Keep existing `detectCreditCardCharge` function** - still needed for extracting card last four from bank descriptions

2. **Remove the amount matching functions** - `amountsMatch` and `isWithinDateWindow` are no longer needed for this simpler approach

3. **Update `linkCreditCardTransactions` function:**
   - Import and use `matchByBillingDate` from billingDateMatcher.ts
   - Pass the dateRangeDays from settings (or accept as parameter with default)
   - The function should now:
     a. Find bank CC charges without linked_credit_card_id
     b. For each charge, extract card last four from description
     c. Find CC transactions with matching value_date (within tolerance) and card
     d. Update bank charge with linked_credit_card_id of matching card
   - Return LinkingResult with linked/unlinked/errors counts

4. **Add new export `relinkByBillingDate(userId: string, options?: { dateRangeDays?: number })`:**
   - Wrapper that calls matchByBillingDate with settings from store
   - Used by UI re-link button

Keep the interface compatible:
```typescript
export interface LinkingResult {
  linked: number
  unlinked: number
  errors: string[]
}
```

Note: The linking now only sets linked_credit_card_id on bank charges. Individual CC transactions are already linked to their cards during upload (via useCreditCardUpload.ts).
  </action>
  <verify>
- File compiles: `npx tsc --noEmit`
- detectCreditCardCharge function still exported
- linkCreditCardTransactions function exported with same interface
- New relinkByBillingDate function exported
  </verify>
  <done>
creditCardLinker.ts updated to use billing date matching instead of amount tolerance.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Both files export expected functions
3. No runtime imports missing
</verification>

<success_criteria>
- billingDateMatcher.ts exists with BillingDateGroup interface and group calculation logic
- creditCardLinker.ts updated to use billing date matching
- Existing detectCreditCardCharge function preserved
- All TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/08-credit-card-to-bank-matching/08-01-SUMMARY.md`
</output>
