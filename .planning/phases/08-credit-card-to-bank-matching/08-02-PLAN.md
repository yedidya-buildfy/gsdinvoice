---
phase: 08-credit-card-to-bank-matching
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/hooks/useBillingDateGroups.ts
  - src/components/creditcard/BillingDateDiscrepancyCard.tsx
autonomous: true

must_haves:
  truths:
    - "User can see billing date groups with discrepancy amounts"
    - "Dashboard displays missing amounts per billing date"
    - "Discrepancy calculation updates reactively"
  artifacts:
    - path: "src/hooks/useBillingDateGroups.ts"
      provides: "React Query hook for billing date groups"
      exports: ["useBillingDateGroups"]
    - path: "src/components/creditcard/BillingDateDiscrepancyCard.tsx"
      provides: "Dashboard card showing billing date discrepancies"
      exports: ["BillingDateDiscrepancyCard"]
  key_links:
    - from: "src/hooks/useBillingDateGroups.ts"
      to: "src/lib/services/billingDateMatcher.ts"
      via: "imports getBillingDateGroups"
      pattern: "import.*getBillingDateGroups"
    - from: "src/components/creditcard/BillingDateDiscrepancyCard.tsx"
      to: "src/hooks/useBillingDateGroups.ts"
      via: "hook consumption"
      pattern: "useBillingDateGroups"
---

<objective>
Create React hook and dashboard component for viewing billing date discrepancies.

Purpose: Allow users to see which billing dates have missing amounts - the difference between what the bank charged and what the credit card statement shows. This is the "dashboard first" approach requested by the user.

Output: useBillingDateGroups hook and BillingDateDiscrepancyCard component.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-credit-card-to-bank-matching/08-01-SUMMARY.md
@src/lib/services/billingDateMatcher.ts
@src/stores/settingsStore.ts
@src/hooks/useCreditCards.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useBillingDateGroups hook</name>
  <files>src/hooks/useBillingDateGroups.ts</files>
  <action>
Create a new hook file `useBillingDateGroups.ts` following the project's hook patterns (see useCreditCards.ts):

```typescript
import { useQuery } from '@tanstack/react-query'
import { useAuth } from '@/contexts/AuthContext'
import { useSettingsStore } from '@/stores/settingsStore'
import { getBillingDateGroups, type BillingDateGroup } from '@/lib/services/billingDateMatcher'

interface UseBillingDateGroupsReturn {
  groups: BillingDateGroup[]
  isLoading: boolean
  error: Error | null
  refetch: () => Promise<any>
  // Computed summaries
  totalDiscrepancy: number // Sum of all discrepancies (agorot)
  groupsWithDiscrepancy: number // Count of groups where discrepancy !== 0
  unmatchedGroups: number // Count of groups without a bank charge match
}

export function useBillingDateGroups(): UseBillingDateGroupsReturn {
  const { user } = useAuth()
  const ccBankDateRangeDays = useSettingsStore((s) => s.ccBankDateRangeDays)

  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['billing_date_groups', user?.id, ccBankDateRangeDays],
    queryFn: () => getBillingDateGroups(user!.id, ccBankDateRangeDays),
    enabled: !!user,
    staleTime: 30000, // 30s consistent with project pattern
  })

  const groups = data || []

  // Compute summaries
  const totalDiscrepancy = groups.reduce((sum, g) => sum + g.discrepancy, 0)
  const groupsWithDiscrepancy = groups.filter((g) => g.discrepancy !== 0).length
  const unmatchedGroups = groups.filter((g) => g.bankChargeId === null).length

  return {
    groups,
    isLoading,
    error: error as Error | null,
    refetch,
    totalDiscrepancy,
    groupsWithDiscrepancy,
    unmatchedGroups,
  }
}
```

Key points:
- Use TanStack Query with 30s staleTime (project pattern)
- Include dateRangeDays in query key for cache invalidation when setting changes
- Compute summary values for dashboard display
  </action>
  <verify>
- File exists at src/hooks/useBillingDateGroups.ts
- Exports useBillingDateGroups function
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useBillingDateGroups hook created with reactive settings integration and summary calculations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BillingDateDiscrepancyCard component</name>
  <files>src/components/creditcard/BillingDateDiscrepancyCard.tsx</files>
  <action>
Create a dashboard card component showing billing date discrepancies:

```typescript
import { ExclamationTriangleIcon, CheckCircleIcon, CreditCardIcon } from '@heroicons/react/24/outline'
import { useBillingDateGroups } from '@/hooks/useBillingDateGroups'
import { agorotToShekel } from '@/lib/utils/currency'

export function BillingDateDiscrepancyCard() {
  const {
    groups,
    isLoading,
    totalDiscrepancy,
    groupsWithDiscrepancy,
    unmatchedGroups
  } = useBillingDateGroups()

  // Format currency for display
  const formatAmount = (agorot: number) => {
    const shekel = agorotToShekel(Math.abs(agorot))
    const sign = agorot < 0 ? '-' : ''
    return `${sign}${new Intl.NumberFormat('he-IL', {
      style: 'currency',
      currency: 'ILS',
    }).format(shekel)}`
  }

  if (isLoading) {
    return (
      <div className="bg-surface rounded-lg p-6 animate-pulse">
        <div className="h-6 w-48 bg-text-muted/20 rounded mb-4" />
        <div className="h-10 w-32 bg-text-muted/20 rounded" />
      </div>
    )
  }

  const hasIssues = groupsWithDiscrepancy > 0 || unmatchedGroups > 0

  return (
    <div className="bg-surface rounded-lg p-6">
      <div className="flex items-start gap-4 mb-4">
        <div className={`p-2 rounded-lg ${hasIssues ? 'bg-amber-500/10' : 'bg-primary/10'}`}>
          {hasIssues ? (
            <ExclamationTriangleIcon className="w-5 h-5 text-amber-500" />
          ) : (
            <CheckCircleIcon className="w-5 h-5 text-primary" />
          )}
        </div>
        <div>
          <h3 className="text-lg font-semibold text-text">Credit Card Billing</h3>
          <p className="text-sm text-text-muted">
            {groups.length} billing date{groups.length !== 1 ? 's' : ''} tracked
          </p>
        </div>
      </div>

      {/* Summary stats */}
      <div className="grid grid-cols-3 gap-4 mb-4">
        <div className="text-center">
          <div className="text-2xl font-bold text-text">
            {groupsWithDiscrepancy}
          </div>
          <div className="text-xs text-text-muted">With discrepancy</div>
        </div>
        <div className="text-center">
          <div className="text-2xl font-bold text-text">
            {unmatchedGroups}
          </div>
          <div className="text-xs text-text-muted">Unmatched</div>
        </div>
        <div className="text-center">
          <div className={`text-2xl font-bold ${totalDiscrepancy > 0 ? 'text-amber-500' : totalDiscrepancy < 0 ? 'text-red-400' : 'text-primary'}`}>
            {formatAmount(totalDiscrepancy)}
          </div>
          <div className="text-xs text-text-muted">Total discrepancy</div>
        </div>
      </div>

      {/* Recent discrepancies list (top 3) */}
      {groupsWithDiscrepancy > 0 && (
        <div className="border-t border-text-muted/10 pt-4">
          <h4 className="text-sm font-medium text-text mb-2">Recent discrepancies</h4>
          <div className="space-y-2">
            {groups
              .filter((g) => g.discrepancy !== 0)
              .slice(0, 3)
              .map((group) => (
                <div
                  key={`${group.billingDate}-${group.cardLastFour}`}
                  className="flex items-center justify-between text-sm"
                >
                  <div className="flex items-center gap-2">
                    <CreditCardIcon className="w-4 h-4 text-text-muted" />
                    <span className="text-text-muted">
                      {new Date(group.billingDate).toLocaleDateString('he-IL')}
                    </span>
                    <span className="text-xs text-text-muted">
                      ****{group.cardLastFour}
                    </span>
                  </div>
                  <span className={group.discrepancy > 0 ? 'text-amber-500' : 'text-red-400'}>
                    {group.discrepancy > 0 ? 'Missing: ' : 'Over: '}
                    {formatAmount(group.discrepancy)}
                  </span>
                </div>
              ))}
          </div>
        </div>
      )}
    </div>
  )
}
```

Key features:
- Shows summary: groups with discrepancies, unmatched groups, total discrepancy
- Color coding: amber for positive discrepancy (missing), red for negative (over), green for zero
- Lists top 3 recent discrepancies with card and date info
- Loading skeleton state
- Uses HeroIcons thin outline (project convention)
- Hebrew date formatting
  </action>
  <verify>
- File exists at src/components/creditcard/BillingDateDiscrepancyCard.tsx
- Exports BillingDateDiscrepancyCard component
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
BillingDateDiscrepancyCard component created showing billing date discrepancies with summary and details.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Both hook and component export correctly
3. Component renders without console errors (visual check in next plan)
</verification>

<success_criteria>
- useBillingDateGroups hook created with query integration
- BillingDateDiscrepancyCard component shows discrepancy data
- Both files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-credit-card-to-bank-matching/08-02-SUMMARY.md`
</output>
