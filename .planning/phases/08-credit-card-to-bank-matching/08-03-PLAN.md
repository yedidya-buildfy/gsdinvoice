---
phase: 08-credit-card-to-bank-matching
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/creditcard/ManualLinkModal.tsx
  - src/hooks/useManualLink.ts
autonomous: true

must_haves:
  truths:
    - "User can manually link CC transactions to a bank charge"
    - "User can unlink CC transactions from bank charges"
    - "Manual linking updates database immediately"
  artifacts:
    - path: "src/hooks/useManualLink.ts"
      provides: "Mutations for manual link/unlink operations"
      exports: ["useManualLink", "useUnlinkTransaction"]
    - path: "src/components/creditcard/ManualLinkModal.tsx"
      provides: "Modal for manual linking flow"
      exports: ["ManualLinkModal"]
  key_links:
    - from: "src/hooks/useManualLink.ts"
      to: "transactions table"
      via: "supabase update"
      pattern: "supabase.*update.*transactions"
---

<objective>
Create manual link/unlink functionality for credit card to bank matching.

Purpose: Allow users to manually link or unlink credit card transactions to/from bank charges when automatic matching doesn't work or needs correction.

Output: useManualLink hook and ManualLinkModal component.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-credit-card-to-bank-matching/08-01-SUMMARY.md
@src/types/database.ts
@src/hooks/useCreditCards.ts
@src/components/ui/base/modal/confirm-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useManualLink hook</name>
  <files>src/hooks/useManualLink.ts</files>
  <action>
Create a hook for manual link/unlink operations:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase'
import { useAuth } from '@/contexts/AuthContext'
import type { Transaction } from '@/types/database'

interface LinkInput {
  ccTransactionIds: string[] // CC transactions to link
  bankChargeId: string // Bank charge to link to
}

interface UnlinkInput {
  bankChargeId: string // Bank charge to unlink
}

/**
 * Hook for manual linking CC transactions to a bank charge
 * Links by setting linked_credit_card_id on the bank charge
 */
export function useManualLink() {
  const { user } = useAuth()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: LinkInput) => {
      if (!user) throw new Error('User not authenticated')

      // First, get the credit card ID from one of the CC transactions
      const { data: ccTx, error: fetchError } = await supabase
        .from('transactions')
        .select('linked_credit_card_id')
        .eq('id', input.ccTransactionIds[0])
        .single()

      if (fetchError) {
        throw new Error(`Failed to fetch CC transaction: ${fetchError.message}`)
      }

      if (!ccTx.linked_credit_card_id) {
        throw new Error('CC transaction has no linked credit card')
      }

      // Update the bank charge with the credit card ID
      const { error: updateError } = await supabase
        .from('transactions')
        .update({ linked_credit_card_id: ccTx.linked_credit_card_id })
        .eq('id', input.bankChargeId)
        .eq('user_id', user.id)
        .eq('is_credit_card_charge', true)

      if (updateError) {
        throw new Error(`Failed to link: ${updateError.message}`)
      }

      return { success: true }
    },
    onSuccess: () => {
      // Invalidate all related queries
      queryClient.invalidateQueries({ queryKey: ['billing_date_groups'] })
      queryClient.invalidateQueries({ queryKey: ['transactions'] })
      queryClient.invalidateQueries({ queryKey: ['credit_card_transactions'] })
    },
  })
}

/**
 * Hook for unlinking a bank charge from credit card
 */
export function useUnlinkTransaction() {
  const { user } = useAuth()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: UnlinkInput) => {
      if (!user) throw new Error('User not authenticated')

      // Clear the linked_credit_card_id on the bank charge
      const { error } = await supabase
        .from('transactions')
        .update({ linked_credit_card_id: null })
        .eq('id', input.bankChargeId)
        .eq('user_id', user.id)
        .eq('is_credit_card_charge', true)

      if (error) {
        throw new Error(`Failed to unlink: ${error.message}`)
      }

      return { success: true }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['billing_date_groups'] })
      queryClient.invalidateQueries({ queryKey: ['transactions'] })
      queryClient.invalidateQueries({ queryKey: ['credit_card_transactions'] })
    },
  })
}

/**
 * Hook for fetching available bank charges that can be linked
 * Returns bank CC charges without linked_credit_card_id
 */
export function useUnlinkedBankCharges() {
  const { user } = useAuth()

  return useMutation({
    mutationFn: async (cardLastFour?: string) => {
      if (!user) throw new Error('User not authenticated')

      let query = supabase
        .from('transactions')
        .select('*')
        .eq('user_id', user.id)
        .eq('is_credit_card_charge', true)
        .is('linked_credit_card_id', null)
        .order('date', { ascending: false })
        .limit(50)

      // If cardLastFour provided, filter by description containing it
      if (cardLastFour) {
        query = query.ilike('description', `%${cardLastFour}%`)
      }

      const { data, error } = await query

      if (error) {
        throw new Error(`Failed to fetch bank charges: ${error.message}`)
      }

      return data as Transaction[]
    },
  })
}
```

Key features:
- useManualLink: Links CC transactions to a bank charge
- useUnlinkTransaction: Removes link from bank charge
- useUnlinkedBankCharges: Fetches available unlinked bank charges
- All mutations invalidate relevant queries for reactivity
  </action>
  <verify>
- File exists at src/hooks/useManualLink.ts
- Exports useManualLink, useUnlinkTransaction, useUnlinkedBankCharges
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useManualLink hook created with link, unlink, and fetch unlinked operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ManualLinkModal component</name>
  <files>src/components/creditcard/ManualLinkModal.tsx</files>
  <action>
Create a modal component for manual linking:

```typescript
import { useState, useEffect } from 'react'
import { XMarkIcon, LinkIcon, MagnifyingGlassIcon } from '@heroicons/react/24/outline'
import { useManualLink, useUnlinkedBankCharges } from '@/hooks/useManualLink'
import { agorotToShekel } from '@/lib/utils/currency'
import type { Transaction } from '@/types/database'
import type { BillingDateGroup } from '@/lib/services/billingDateMatcher'

interface ManualLinkModalProps {
  isOpen: boolean
  onClose: () => void
  group: BillingDateGroup | null // The billing date group to link
  onSuccess?: () => void
}

export function ManualLinkModal({ isOpen, onClose, group, onSuccess }: ManualLinkModalProps) {
  const [selectedChargeId, setSelectedChargeId] = useState<string | null>(null)
  const [bankCharges, setBankCharges] = useState<Transaction[]>([])

  const manualLinkMutation = useManualLink()
  const fetchBankChargesMutation = useUnlinkedBankCharges()

  // Format currency
  const formatAmount = (agorot: number) => {
    return new Intl.NumberFormat('he-IL', {
      style: 'currency',
      currency: 'ILS',
    }).format(agorotToShekel(Math.abs(agorot)))
  }

  // Fetch bank charges when modal opens
  useEffect(() => {
    if (isOpen && group) {
      fetchBankChargesMutation.mutate(group.cardLastFour, {
        onSuccess: (data) => setBankCharges(data),
      })
    }
    return () => {
      setSelectedChargeId(null)
      setBankCharges([])
    }
  }, [isOpen, group?.cardLastFour])

  const handleLink = async () => {
    if (!selectedChargeId || !group) return

    manualLinkMutation.mutate(
      {
        ccTransactionIds: group.ccTransactionIds,
        bankChargeId: selectedChargeId,
      },
      {
        onSuccess: () => {
          onSuccess?.()
          onClose()
        },
      }
    )
  }

  if (!isOpen || !group) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/50"
        onClick={onClose}
      />

      {/* Modal */}
      <div className="relative bg-surface rounded-lg shadow-xl w-full max-w-lg mx-4 max-h-[80vh] flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-text-muted/10">
          <div>
            <h2 className="text-lg font-semibold text-text">Manual Link</h2>
            <p className="text-sm text-text-muted">
              Billing date: {new Date(group.billingDate).toLocaleDateString('he-IL')} - Card ****{group.cardLastFour}
            </p>
          </div>
          <button
            type="button"
            onClick={onClose}
            className="p-2 text-text-muted hover:text-text rounded-lg transition-colors"
          >
            <XMarkIcon className="w-5 h-5" />
          </button>
        </div>

        {/* Content */}
        <div className="p-4 overflow-y-auto flex-1">
          {/* CC Transactions summary */}
          <div className="mb-4 p-3 bg-background/50 rounded-lg">
            <div className="text-sm text-text-muted mb-1">CC Transactions Total:</div>
            <div className="text-lg font-semibold text-text">
              {formatAmount(group.ccTransactionsTotal)} ({group.ccTransactionIds.length} transactions)
            </div>
          </div>

          {/* Bank charges list */}
          <div className="space-y-2">
            <div className="text-sm font-medium text-text">Select bank charge to link:</div>

            {fetchBankChargesMutation.isPending ? (
              <div className="text-center py-4 text-text-muted">Loading...</div>
            ) : bankCharges.length === 0 ? (
              <div className="text-center py-4 text-text-muted">
                No unlinked bank charges found for this card
              </div>
            ) : (
              <div className="space-y-2 max-h-[300px] overflow-y-auto">
                {bankCharges.map((charge) => (
                  <button
                    key={charge.id}
                    type="button"
                    onClick={() => setSelectedChargeId(charge.id)}
                    className={`w-full p-3 rounded-lg border text-start transition-colors ${
                      selectedChargeId === charge.id
                        ? 'border-primary bg-primary/10'
                        : 'border-text-muted/20 hover:border-text-muted/40 bg-background/30'
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="text-sm font-medium text-text">
                          {charge.description}
                        </div>
                        <div className="text-xs text-text-muted">
                          {new Date(charge.date).toLocaleDateString('he-IL')}
                        </div>
                      </div>
                      <div className="text-sm font-semibold text-red-400">
                        {formatAmount(charge.amount_agorot)}
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="flex items-center justify-end gap-2 p-4 border-t border-text-muted/10">
          <button
            type="button"
            onClick={onClose}
            className="px-4 py-2 text-text-muted hover:text-text transition-colors"
          >
            Cancel
          </button>
          <button
            type="button"
            onClick={handleLink}
            disabled={!selectedChargeId || manualLinkMutation.isPending}
            className="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <LinkIcon className="w-4 h-4" />
            {manualLinkMutation.isPending ? 'Linking...' : 'Link'}
          </button>
        </div>
      </div>
    </div>
  )
}
```

Key features:
- Shows CC transactions summary for the billing date group
- Lists available unlinked bank charges
- Allows selection and linking
- Loading and empty states
- Dark theme styling consistent with project
- Hebrew date formatting
  </action>
  <verify>
- File exists at src/components/creditcard/ManualLinkModal.tsx
- Exports ManualLinkModal component
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
ManualLinkModal component created for manual linking flow.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Hook exports all required functions
3. Modal component renders correctly
</verification>

<success_criteria>
- useManualLink hook provides link/unlink mutations
- ManualLinkModal allows user to select and link bank charges
- Both files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-credit-card-to-bank-matching/08-03-SUMMARY.md`
</output>
