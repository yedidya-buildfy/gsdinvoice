---
phase: 08-credit-card-to-bank-matching
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - src/pages/DashboardPage.tsx
  - src/components/creditcard/BillingDateGroupsTable.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows billing date discrepancy card"
    - "User can view detailed table of all billing date groups"
    - "Unlinked groups are visually flagged for review"
    - "User can trigger manual linking from the table"
  artifacts:
    - path: "src/pages/DashboardPage.tsx"
      provides: "Updated dashboard with discrepancy card"
      contains: "BillingDateDiscrepancyCard"
    - path: "src/components/creditcard/BillingDateGroupsTable.tsx"
      provides: "Detailed table of billing date groups"
      exports: ["BillingDateGroupsTable"]
  key_links:
    - from: "src/pages/DashboardPage.tsx"
      to: "src/components/creditcard/BillingDateDiscrepancyCard.tsx"
      via: "component import"
      pattern: "import.*BillingDateDiscrepancyCard"
    - from: "src/components/creditcard/BillingDateGroupsTable.tsx"
      to: "src/hooks/useBillingDateGroups.ts"
      via: "hook consumption"
      pattern: "useBillingDateGroups"
---

<objective>
Integrate billing date matching into Dashboard and create detailed groups table.

Purpose: Complete the UI integration by adding the discrepancy card to the Dashboard and creating a detailed table view where users can see all billing date groups, identify unlinked transactions, and trigger manual linking.

Output: Updated DashboardPage.tsx with billing card and new BillingDateGroupsTable component.
</objective>

<execution_context>
@/Users/yedidya/.claude/get-shit-done/workflows/execute-plan.md
@/Users/yedidya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-credit-card-to-bank-matching/08-02-SUMMARY.md
@.planning/phases/08-credit-card-to-bank-matching/08-03-SUMMARY.md
@src/pages/DashboardPage.tsx
@src/components/creditcard/BillingDateDiscrepancyCard.tsx
@src/components/creditcard/ManualLinkModal.tsx
@src/hooks/useBillingDateGroups.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BillingDateGroupsTable component</name>
  <files>src/components/creditcard/BillingDateGroupsTable.tsx</files>
  <action>
Create a detailed table component showing all billing date groups with ability to link/unlink:

```typescript
import { useState } from 'react'
import {
  ExclamationTriangleIcon,
  CheckCircleIcon,
  LinkIcon,
  LinkSlashIcon,
} from '@heroicons/react/24/outline'
import { useBillingDateGroups } from '@/hooks/useBillingDateGroups'
import { useUnlinkTransaction } from '@/hooks/useManualLink'
import { ManualLinkModal } from './ManualLinkModal'
import { agorotToShekel } from '@/lib/utils/currency'
import type { BillingDateGroup } from '@/lib/services/billingDateMatcher'

interface BillingDateGroupsTableProps {
  showOnlyUnlinked?: boolean
}

export function BillingDateGroupsTable({ showOnlyUnlinked = false }: BillingDateGroupsTableProps) {
  const { groups, isLoading, refetch } = useBillingDateGroups()
  const unlinkMutation = useUnlinkTransaction()
  const [selectedGroup, setSelectedGroup] = useState<BillingDateGroup | null>(null)

  // Format currency
  const formatAmount = (agorot: number) => {
    return new Intl.NumberFormat('he-IL', {
      style: 'currency',
      currency: 'ILS',
    }).format(agorotToShekel(Math.abs(agorot)))
  }

  // Filter if needed
  const displayGroups = showOnlyUnlinked
    ? groups.filter((g) => g.bankChargeId === null)
    : groups

  const handleUnlink = async (group: BillingDateGroup) => {
    if (!group.bankChargeId) return

    unlinkMutation.mutate(
      { bankChargeId: group.bankChargeId },
      { onSuccess: () => refetch() }
    )
  }

  if (isLoading) {
    return (
      <div className="bg-surface rounded-lg overflow-hidden">
        <div className="animate-pulse p-4">
          <div className="h-6 w-48 bg-text-muted/20 rounded mb-4" />
          <div className="space-y-3">
            {[1, 2, 3].map((i) => (
              <div key={i} className="h-12 bg-text-muted/10 rounded" />
            ))}
          </div>
        </div>
      </div>
    )
  }

  if (displayGroups.length === 0) {
    return (
      <div className="bg-surface rounded-lg p-8 text-center">
        <CheckCircleIcon className="w-12 h-12 text-primary mx-auto mb-3" />
        <h3 className="text-lg font-medium text-text mb-1">
          {showOnlyUnlinked ? 'All groups linked' : 'No billing date groups'}
        </h3>
        <p className="text-sm text-text-muted">
          {showOnlyUnlinked
            ? 'All credit card billing dates are matched to bank charges.'
            : 'Import credit card statements to see billing date groups.'}
        </p>
      </div>
    )
  }

  return (
    <>
      <div className="bg-surface rounded-lg overflow-hidden">
        <table className="w-full" dir="rtl">
          <thead className="bg-background/50">
            <tr>
              <th className="px-4 py-3 text-start text-xs font-medium text-text-muted uppercase tracking-wider">
                Status
              </th>
              <th className="px-4 py-3 text-start text-xs font-medium text-text-muted uppercase tracking-wider">
                Billing Date
              </th>
              <th className="px-4 py-3 text-start text-xs font-medium text-text-muted uppercase tracking-wider">
                Card
              </th>
              <th className="px-4 py-3 text-end text-xs font-medium text-text-muted uppercase tracking-wider">
                CC Total
              </th>
              <th className="px-4 py-3 text-end text-xs font-medium text-text-muted uppercase tracking-wider">
                Bank Charge
              </th>
              <th className="px-4 py-3 text-end text-xs font-medium text-text-muted uppercase tracking-wider">
                Discrepancy
              </th>
              <th className="px-4 py-3 text-center text-xs font-medium text-text-muted uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-text-muted/10">
            {displayGroups.map((group) => {
              const isLinked = group.bankChargeId !== null
              const hasDiscrepancy = group.discrepancy !== 0

              return (
                <tr
                  key={`${group.billingDate}-${group.cardLastFour}`}
                  className={`hover:bg-background/30 ${!isLinked ? 'bg-amber-500/5' : ''}`}
                >
                  {/* Status */}
                  <td className="px-4 py-3">
                    {isLinked ? (
                      hasDiscrepancy ? (
                        <span className="inline-flex items-center gap-1 text-amber-500">
                          <ExclamationTriangleIcon className="w-4 h-4" />
                          <span className="text-xs">Discrepancy</span>
                        </span>
                      ) : (
                        <span className="inline-flex items-center gap-1 text-primary">
                          <CheckCircleIcon className="w-4 h-4" />
                          <span className="text-xs">Matched</span>
                        </span>
                      )
                    ) : (
                      <span className="inline-flex items-center gap-1 text-red-400">
                        <ExclamationTriangleIcon className="w-4 h-4" />
                        <span className="text-xs">Unlinked</span>
                      </span>
                    )}
                  </td>

                  {/* Billing Date */}
                  <td className="px-4 py-3 text-sm text-text">
                    {new Date(group.billingDate).toLocaleDateString('he-IL')}
                  </td>

                  {/* Card */}
                  <td className="px-4 py-3 text-sm text-text-muted">
                    ****{group.cardLastFour}
                  </td>

                  {/* CC Total */}
                  <td className="px-4 py-3 text-sm text-end text-text">
                    {formatAmount(group.ccTransactionsTotal)}
                    <div className="text-xs text-text-muted">
                      {group.ccTransactionIds.length} items
                    </div>
                  </td>

                  {/* Bank Charge */}
                  <td className="px-4 py-3 text-sm text-end">
                    {group.bankChargeAmount > 0 ? (
                      <span className="text-text">{formatAmount(group.bankChargeAmount)}</span>
                    ) : (
                      <span className="text-text-muted">-</span>
                    )}
                  </td>

                  {/* Discrepancy */}
                  <td className="px-4 py-3 text-sm text-end">
                    {hasDiscrepancy ? (
                      <span className={group.discrepancy > 0 ? 'text-amber-500' : 'text-red-400'}>
                        {group.discrepancy > 0 ? '+' : ''}{formatAmount(group.discrepancy)}
                      </span>
                    ) : (
                      <span className="text-primary">0</span>
                    )}
                  </td>

                  {/* Actions */}
                  <td className="px-4 py-3 text-center">
                    {isLinked ? (
                      <button
                        type="button"
                        onClick={() => handleUnlink(group)}
                        disabled={unlinkMutation.isPending}
                        className="p-1.5 text-text-muted hover:text-red-400 rounded transition-colors"
                        title="Unlink"
                      >
                        <LinkSlashIcon className="w-4 h-4" />
                      </button>
                    ) : (
                      <button
                        type="button"
                        onClick={() => setSelectedGroup(group)}
                        className="p-1.5 text-primary hover:text-primary/80 rounded transition-colors"
                        title="Link manually"
                      >
                        <LinkIcon className="w-4 h-4" />
                      </button>
                    )}
                  </td>
                </tr>
              )
            })}
          </tbody>
        </table>
      </div>

      {/* Manual Link Modal */}
      <ManualLinkModal
        isOpen={!!selectedGroup}
        onClose={() => setSelectedGroup(null)}
        group={selectedGroup}
        onSuccess={() => refetch()}
      />
    </>
  )
}
```

Key features:
- RTL table layout (dir="rtl")
- Status column with icons (Matched, Discrepancy, Unlinked)
- Unlinked rows highlighted with amber background
- Link/Unlink action buttons
- Opens ManualLinkModal for linking
- Hebrew date formatting
- Loading skeleton and empty states
  </action>
  <verify>
- File exists at src/components/creditcard/BillingDateGroupsTable.tsx
- Exports BillingDateGroupsTable component
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
BillingDateGroupsTable component created with full CRUD actions and status display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DashboardPage with billing card</name>
  <files>src/pages/DashboardPage.tsx</files>
  <action>
Update the DashboardPage to include the BillingDateDiscrepancyCard and improve the layout:

```typescript
import { useEffect, useState } from 'react'
import { useAuth } from '@/contexts/AuthContext'
import { supabase } from '@/lib/supabase'
import { BillingDateDiscrepancyCard } from '@/components/creditcard/BillingDateDiscrepancyCard'
import { BillingDateGroupsTable } from '@/components/creditcard/BillingDateGroupsTable'

type ConnectionStatus = 'checking' | 'connected' | 'error'

export function DashboardPage() {
  const { user } = useAuth()
  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus>('checking')

  useEffect(() => {
    const checkConnection = async () => {
      try {
        const { error } = await supabase.from('user_settings').select('id').limit(1)
        if (error) throw error
        setConnectionStatus('connected')
      } catch {
        setConnectionStatus('error')
      }
    }
    checkConnection()
  }, [])

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-text">Dashboard</h1>
        <span
          className={`text-sm px-2 py-1 rounded ${
            connectionStatus === 'connected'
              ? 'bg-primary/10 text-primary'
              : connectionStatus === 'error'
                ? 'bg-red-500/10 text-red-500'
                : 'bg-text-muted/10 text-text-muted'
          }`}
        >
          {connectionStatus === 'connected' ? 'Connected' : connectionStatus === 'error' ? 'Connection Error' : 'Checking...'}
        </span>
      </div>

      {/* Welcome card */}
      <div className="bg-surface rounded-lg p-6">
        <h2 className="text-lg font-semibold text-text mb-2">Welcome</h2>
        <p className="text-text-secondary">
          VAT Declaration Manager - Track your invoices, expenses, and VAT obligations.
        </p>
        {user?.email && (
          <p className="text-text-muted text-sm mt-2">
            Signed in as: {user.email}
          </p>
        )}
      </div>

      {/* Dashboard cards grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Credit Card Billing card */}
        <BillingDateDiscrepancyCard />

        {/* Placeholder for future cards */}
        <div className="bg-surface rounded-lg p-6">
          <h3 className="text-lg font-semibold text-text mb-2">Invoice Matching</h3>
          <p className="text-sm text-text-muted">
            Coming in Phase 9: Match invoices to expenses.
          </p>
        </div>
      </div>

      {/* Billing Date Groups Table */}
      <div className="bg-surface rounded-lg p-6">
        <h2 className="text-lg font-semibold text-text mb-4">Credit Card Billing Status</h2>
        <BillingDateGroupsTable />
      </div>
    </div>
  )
}
```

Key changes:
- Added BillingDateDiscrepancyCard to dashboard grid
- Added BillingDateGroupsTable showing detailed billing status
- Improved header with connection status badge
- Added placeholder for future Phase 9 card
- Grid layout (2 cols on lg, 1 on mobile)
- Consistent spacing and styling
  </action>
  <verify>
- File updated at src/pages/DashboardPage.tsx
- Imports BillingDateDiscrepancyCard and BillingDateGroupsTable
- TypeScript compiles: `npx tsc --noEmit`
- Page renders without errors: `npm run dev` and check /dashboard
  </verify>
  <done>
DashboardPage updated with billing date discrepancy card and groups table.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Dashboard page renders with billing components
3. BillingDateGroupsTable shows groups and allows link/unlink
4. Dev server: `npm run dev` - navigate to dashboard, verify components render
</verification>

<success_criteria>
- DashboardPage shows BillingDateDiscrepancyCard
- BillingDateGroupsTable displays all billing date groups
- Unlinked groups are flagged visually
- Manual link button opens modal
- Unlink button removes link from bank charge
</success_criteria>

<output>
After completion, create `.planning/phases/08-credit-card-to-bank-matching/08-04-SUMMARY.md`
</output>
