# Phase 13: VAT Fields for Bank Transactions

## Goal
Users can track VAT on bank transactions with merchant-level settings

## Implementation Summary

### Database Changes (Applied)
1. Added to `transactions` table:
   - `has_vat` (boolean, default false)
   - `vat_percentage` (numeric 5,2, default 18)
   - `vat_amount_agorot` (integer, calculated)

2. Created `merchant_vat_preferences` table:
   - Stores per-user merchant VAT preferences for future imports
   - Unique constraint on (user_id, merchant_name)
   - RLS enabled

### Files Created
- `src/lib/utils/merchantParser.ts` - Parse merchant name from Hebrew bank descriptions
- `src/lib/utils/vatCalculator.ts` - VAT calculation utilities
- `src/components/ui/base/modal/modal.tsx` - Reusable React Aria modal
- `src/components/bank/VatChangeModal.tsx` - VAT change options modal
- `src/hooks/useUpdateTransactionVat.ts` - VAT update mutations

### Files Modified
- `src/types/database.ts` - Added VAT fields and merchant_vat_preferences types
- `src/components/bank/TransactionTable.tsx`:
  - Date column smaller (DD/MM/YY format)
  - Added VAT columns: checkbox, percentage input, amount display
  - Added onVatChange callback
- `src/pages/BankMovementsPage.tsx`:
  - Added VAT modal state and handlers
  - Integrated VatChangeModal

## Features
1. VAT toggle (yes/no) per transaction - default no
2. VAT percentage input - default 18%, disabled when VAT is off
3. VAT amount auto-calculated from total
4. When VAT changed, modal offers:
   - Apply to all past orders from this merchant
   - Only this order
   - All future orders (saves preference)

## Status
- [x] Database migrations applied
- [x] Types updated
- [x] Utility functions created
- [x] Modal component created
- [x] Table updated with VAT columns
- [x] Page integrated with modal handlers
